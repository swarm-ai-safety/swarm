#!/bin/bash
# Pre-commit hook to detect hardcoded API keys and secrets
#
# Install: cp .claude/hooks/pre-commit-secrets .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

# Patterns that indicate potential secrets
PATTERNS=(
    'ax_[0-9a-f]{32}'           # agentxiv API keys
    'clx_[0-9a-f]{32}'          # clawxiv API keys
    'sk-[A-Za-z0-9]{48}'        # OpenAI API keys
    'sk_live_[A-Za-z0-9]+'      # Stripe live keys
    'AKIA[0-9A-Z]{16}'          # AWS access keys
    'ghp_[A-Za-z0-9]{36}'       # GitHub personal tokens
    'gho_[A-Za-z0-9]{36}'       # GitHub OAuth tokens
    'moltbook_sk_[A-Za-z0-9_]+' # Moltbook API keys
    'moltipedia_[0-9a-f]{64}'   # Moltipedia API keys
    'wm_[0-9a-f]{32}'           # Wikimolt API keys
    'clawchan_[0-9a-f]{48}'     # 4claw API keys
    'clawk_[0-9a-f]{32}'        # Clawk API keys
    'API_KEY\s*=\s*["\x27][^"\x27]{20,}["\x27]'  # Generic API_KEY assignments
    'Bearer\s+[A-Za-z0-9_-]{20,}'  # Bearer tokens in strings
)

# Files to check (staged files only)
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py|js|ts|yaml|yml|json|sh|env|md)$')

if [ -z "$FILES" ]; then
    exit 0
fi

FOUND=0

for pattern in "${PATTERNS[@]}"; do
    # Check staged content, not working directory
    MATCHES=$(git diff --cached -U0 | grep -E "^\+" | grep -E "$pattern" || true)
    if [ -n "$MATCHES" ]; then
        echo "ERROR: Potential secret detected matching pattern: $pattern"
        echo "$MATCHES" | head -5
        echo ""
        FOUND=1
    fi
done

if [ $FOUND -eq 1 ]; then
    echo "=========================================="
    echo "COMMIT BLOCKED: Potential secrets detected"
    echo "=========================================="
    echo ""
    echo "If this is a false positive, you can:"
    echo "  1. Use environment variables instead of hardcoding"
    echo "  2. Skip this check with: git commit --no-verify"
    echo ""
    echo "To use environment variables:"
    echo "  import os"
    echo "  api_key = os.environ.get('YOUR_API_KEY')"
    echo ""
    exit 1
fi

exit 0
