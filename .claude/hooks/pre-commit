#!/usr/bin/env bash
# Source of truth: .claude/hooks/pre-commit
# Install with: cp .claude/hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
set -euo pipefail

if [[ "${SKIP_SWARM_HOOKS:-0}" == "1" ]]; then
  echo "[swarm pre-commit] SKIP_SWARM_HOOKS=1 set; skipping."
  exit 0
fi

ROOT=$(git rev-parse --show-toplevel 2>/dev/null || true)
if [ -z "$ROOT" ]; then
  echo "[swarm pre-commit] Could not determine repo root."
  exit 1
fi
cd "$ROOT"

# ── 0. Gitignore enforcement (auto-unstage junk before anything else) ──
JUNK=$(git diff --cached --name-only | grep -E '(\.DS_Store|\.db$|\.env$|credentials)' || true)
if [ -n "$JUNK" ]; then
    echo "[swarm pre-commit] unstaging junk files:"
    echo "$JUNK" | while read -r f; do echo "  - $f"; done
    echo "$JUNK" | xargs git reset HEAD --quiet
fi

# ── 1. Secrets scan (must run first, blocks on any match) ──
echo "[swarm pre-commit] secrets scan"

PATTERNS=(
    'ax_[0-9a-f]{32}'           # agentxiv API keys
    'clx_[0-9a-f]{32}'          # clawxiv API keys
    'sk-[A-Za-z0-9]{48}'        # OpenAI API keys
    'sk_live_[A-Za-z0-9]+'      # Stripe live keys
    'AKIA[0-9A-Z]{16}'          # AWS access keys
    'ghp_[A-Za-z0-9]{36}'       # GitHub personal tokens
    'gho_[A-Za-z0-9]{36}'       # GitHub OAuth tokens
    'moltbook_sk_[A-Za-z0-9_]+' # Moltbook API keys
    'moltipedia_[0-9a-f]{64}'   # Moltipedia API keys
    'wm_[0-9a-f]{32}'           # Wikimolt API keys
    'clawchan_[0-9a-f]{48}'     # 4claw API keys
    'clawk_[0-9a-f]{32}'        # Clawk API keys
    'API_KEY\s*=\s*["\x27][^"\x27]{20,}["\x27]'  # Generic API_KEY assignments
    'Bearer\s+[A-Za-z0-9_-]{20,}'  # Bearer tokens in strings
)

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py|js|ts|yaml|yml|json|sh|env|md)$' || true)

if [ -n "$STAGED_FILES" ]; then
    FOUND=0
    DIFF=$(git diff --cached -U0)
    for pattern in "${PATTERNS[@]}"; do
        MATCHES=$(echo "$DIFF" | grep -E "^\+" | grep -E "$pattern" || true)
        if [ -n "$MATCHES" ]; then
            echo "ERROR: Potential secret detected matching pattern: $pattern"
            echo "$MATCHES" | head -5
            echo ""
            FOUND=1
        fi
    done

    if [ $FOUND -eq 1 ]; then
        echo "=========================================="
        echo "COMMIT BLOCKED: Potential secrets detected"
        echo "=========================================="
        echo ""
        echo "Use environment variables or credential files instead."
        echo "  api_key = os.environ.get('YOUR_API_KEY')"
        echo "  or load from ~/.config/<platform>/credentials.json"
        echo ""
        exit 1
    fi
    echo "[swarm pre-commit] secrets scan: clean"
fi

# ── 2. Lint/Typecheck (prefer pre-commit if available) ──
if command -v pre-commit >/dev/null 2>&1 && [ -f ".pre-commit-config.yaml" ]; then
    echo "[swarm pre-commit] pre-commit (config hooks)"
    pre-commit run --hook-stage pre-commit
else
    STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)
    if [ -n "$STAGED_PY" ]; then
        echo "[swarm pre-commit] ruff (staged files)"
        ruff check $STAGED_PY

        # ── 3. Type check (staged swarm/ files only) ──
        # Use --follow-imports=silent to type-check without surfacing errors in deps
        # (--follow-imports=skip causes mypy serialization crashes on some files)
        STAGED_SWARM=$(echo "$STAGED_PY" | grep '^swarm/' || true)
        if [ -n "$STAGED_SWARM" ]; then
            echo "[swarm pre-commit] mypy (staged swarm/ files)"
            MYPY_OUTPUT=$(mypy --follow-imports=silent $STAGED_SWARM 2>&1) && true
            MYPY_EXIT=$?
            if [ $MYPY_EXIT -ne 0 ]; then
                if echo "$MYPY_OUTPUT" | grep -q "Internal error\|AssertionError"; then
                    echo "[swarm pre-commit] mypy internal crash (not a lint error); continuing"
                    echo "$MYPY_OUTPUT" | tail -3
                else
                    echo "$MYPY_OUTPUT"
                    exit 1
                fi
            fi
        fi
    else
        echo "[swarm pre-commit] no staged .py files; skipping ruff/mypy"
    fi
fi

# ── 4. Tests ──
echo "[swarm pre-commit] pytest"
python -m pytest tests/ -x -q

echo "[swarm pre-commit] done"
