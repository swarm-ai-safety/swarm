(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{3777:(e,t,a)=>{Promise.resolve().then(a.bind(a,8885))},8885:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>eA});var n=a(5155),r=a(2115);function l(e,t,a){return Math.max(t,Math.min(a,e))}function o(e){return e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2}function i(e,t,a){let n=l((a-e)/(t-e),0,1);return n*n*n*(n*(6*n-15)+10)}function s(e){let t=0;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a)|0;return t>>>0}let c={bg:"#0D1117",panel:"#161B22",border:"#30363D",text:"#E6EDF3",muted:"#7D8590",accent:"#3ECFB4",secondary:"#F2994A",alert:"#EB5757",info:"#2F80ED"},d={honest:{primary:"#1A6B5A",secondary:"#3ECFB4",accent:"#A8EFDF"},opportunistic:{primary:"#8B5E2F",secondary:"#F2994A",accent:"#FCDBB5"},deceptive:{primary:"#5B2D8B",secondary:"#BB6BD9",accent:"#E4BFF5"},adversarial:{primary:"#8B2D2D",secondary:"#EB5757",accent:"#F5BFBF"},rlm:{primary:"#1E4D8B",secondary:"#2F80ED",accent:"#A8CFF5"},crewai:{primary:"#2D6B2D",secondary:"#6FCF97",accent:"#C0F0D0"}},h={honest:"Paladin",opportunistic:"Merchant",deceptive:"Illusionist",adversarial:"Enforcer",rlm:"Technomancer",crewai:"Builder"},u={baseWidth:48,baseHeight:84},f={epochTransition:2e3,arcLifetime:1500},p={honest:{walkRate:.011,bobAmplitude:1.2,bobAsymmetry:.1,legSwingScale:.9,armSwingScale:.8,swayAmplitude:.3,idleBob:.4},opportunistic:{walkRate:.014,bobAmplitude:1.8,bobAsymmetry:.2,legSwingScale:1.1,armSwingScale:1.2,swayAmplitude:.6,idleBob:.6},deceptive:{walkRate:.01,bobAmplitude:.8,bobAsymmetry:.3,legSwingScale:.7,armSwingScale:.6,swayAmplitude:.8,idleBob:.3},adversarial:{walkRate:.016,bobAmplitude:2.2,bobAsymmetry:0,legSwingScale:1.3,armSwingScale:1.4,swayAmplitude:.2,idleBob:.5},rlm:{walkRate:.012,bobAmplitude:1,bobAsymmetry:.15,legSwingScale:1,armSwingScale:.9,swayAmplitude:.4,idleBob:.35},crewai:{walkRate:.013,bobAmplitude:1.5,bobAsymmetry:.1,legSwingScale:1,armSwingScale:1,swayAmplitude:.5,idleBob:.5}},g={charCountMin:5,charCountMax:14,charSpacingMin:.05,charSpacingMax:.12,mutateIntervalMin:50,mutateIntervalMax:120,glowRadiusMin:5,glowRadiusMax:12,gridSize:3,gridSpacing:6};class m{addFromEvents(e,t){for(let a of e)a.epoch===t&&this.arcs.push({id:"arc-".concat(this.arcCounter++),fromId:a.initiator,toId:a.counterparty,p:a.p,accepted:a.accepted,progress:0,epoch:t,interactionType:function(e){switch(e){case"trade":return"trade";case"reply":return"communication";case"collaboration":return"task";case"vote":return"governance";default:return"unknown"}}(a.interaction_type)})}addSyntheticArcs(e,t,a,n,r){let l,o=Math.min(a,2*e.length),i=(l=0|1e3*t+7,()=>{let e=Math.imul((l=l+0x6d2b79f5|0)^l>>>15,1|l);return(((e=e+Math.imul(e^e>>>7,61|e)^e)^e>>>14)>>>0)/0x100000000});for(let a=0;a<o;a++){let a=Math.floor(i()*e.length),l=Math.floor(i()*e.length);l===a&&(l=(l+1)%e.length),this.arcs.push({id:"arc-".concat(this.arcCounter++),fromId:e[a],toId:e[l],p:n+(i()-.5)*.3,accepted:i()<r,progress:.3*i(),epoch:t,interactionType:"unknown"})}}update(e,t){for(let a=this.arcs.length-1;a>=0;a--){let n=this.arcs[a],r=.8+.4*Math.max(0,Math.min(1,n.p));n.progress+=e/f.arcLifetime*r,n.progress>=1&&n.epoch!==t?this.arcs.splice(a,1):n.progress>=1&&(n.progress=1)}}clear(){this.arcs=[],this.arcCounter=0}getActive(){return this.arcs.filter(e=>e.progress<1)}constructor(){this.arcs=[],this.arcCounter=0}}class x{add(e){this.particles.push(...e)}update(e){for(let t=this.particles.length-1;t>=0;t--){let a=this.particles[t];a.x+=a.vx*e,a.y+=a.vy*e,a.life-=e,a.life<=0&&this.particles.splice(t,1)}}clear(){this.particles=[]}constructor(){this.particles=[]}}let y=[];for(let e=65382;e<=65437;e++)y.push(String.fromCharCode(e));for(let e of"0123456789+-*/<>=(){}[];:!?@#$%&^~")y.push(e);function v(){return y[Math.floor(Math.random()*y.length)]}function b(e){return y[((e>>>0)%y.length+y.length)%y.length]}let S="!?X#@$%&";function M(e){return S[((e>>>0)%S.length+S.length)%S.length]}function w(e){return"rgba(0,255,65,".concat(e,")")}function P(e,t){let a,n,r,l=Math.max(0,Math.min(1,e));if(l>.5){let e=(l-.5)*2;a=Math.round(255*(1-e)),n=255,r=Math.round(65*e)}else a=255,n=Math.round(2*l*255),r=0;return"rgba(".concat(a,",").concat(n,",").concat(r,",").concat(t,")")}let T="bold 10px 'Courier New', monospace";class k{spawnBurst(e,t,a){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3;for(let r=0;r<n;r++){let n=300+250*Math.random();this.particles.push({x:e+(Math.random()-.5)*12,y:t+(Math.random()-.5)*6,char:v(),color:P(a,1),alpha:.7+.3*Math.random(),life:n,maxLife:n,vy:.015+.01*Math.random(),vx:(Math.random()-.5)*.006,gravity:3e-5+2e-5*Math.random(),fontSize:8+4*Math.random()})}}update(e){for(let t=this.particles.length-1;t>=0;t--){let a=this.particles[t];a.vy+=a.gravity*e,a.y+=a.vy*e,a.x+=a.vx*e,a.life-=e;let n=Math.max(0,a.life/a.maxLife);a.alpha=n*n*.8,a.life<=0&&this.particles.splice(t,1)}}clear(){this.particles=[]}constructor(){this.particles=[]}}function _(e){return[...new Set(e.map(e=>e.agent_id))]}function C(e,t,a,n,r){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:80,i=l(Math.min(e.width/(n-t+2*o),e.height/(r-a+2*o)),.3,4);return{...e,zoom:i,x:e.width/2-(t+n)/2*i,y:e.height/2-(a+r)/2*i}}function j(e,t){return{x:48*(e-t),y:24*(e+t)}}function F(e,t,a,n,r){e.beginPath(),e.moveTo(t,a-r/2),e.lineTo(t+n/2,a),e.lineTo(t,a+r/2),e.lineTo(t-n/2,a),e.closePath()}let I={data:null,currentEpoch:0,epochFraction:0,playing:!1,speed:1,viewport:{x:0,y:0,width:800,height:600,zoom:1},hoveredAgent:null,selectedAgent:null,overlays:{interactions:!0,metricsHud:!0,threatZones:!0,collusionLines:!0,particles:!0,minimap:!0,digitalRain:!0,tierraStrip:!0,networkWeb:!1},agents:[],arcs:[],environment:{threatLevel:0,toxicity:0,giniCoefficient:0,collusionRisk:0,incoherence:0,contagionDepth:0,activeThreats:0,reputationStd:0,payoffStd:0,avgSynergyScore:0,avgCoordinationScore:0,avgDegree:0,avgClustering:0},particles:[],currentEpochSnap:null,gridSize:10};function E(e,t){switch(t.type){case"LOAD_DATA":{var a;let n=Math.max((Math.ceil(Math.sqrt(_(t.data.agent_snapshots).length))+1)*3+2,10);return{...e,data:t.data,currentEpoch:0,epochFraction:0,playing:!1,gridSize:n,currentEpochSnap:null!=(a=t.data.epoch_snapshots[0])?a:null}}case"SET_EPOCH":return{...e,currentEpoch:t.epoch,epochFraction:0};case"SET_PLAYING":return{...e,playing:t.playing};case"SET_SPEED":return{...e,speed:t.speed};case"SET_VIEWPORT":return{...e,viewport:t.viewport};case"RESIZE":if(e.viewport.width===t.width&&e.viewport.height===t.height)return e;return{...e,viewport:{...e.viewport,width:t.width,height:t.height}};case"SET_HOVERED":return{...e,hoveredAgent:t.agentId};case"SET_SELECTED":return{...e,selectedAgent:t.agentId};case"TOGGLE_OVERLAY":return{...e,overlays:{...e.overlays,[t.key]:!e.overlays[t.key]}};case"TICK":return{...e,agents:t.agents,arcs:t.arcs,environment:t.environment,particles:t.particles,currentEpoch:t.epoch,epochFraction:t.fraction,currentEpochSnap:t.epochSnap};default:return e}}let R=(0,r.createContext)(null);function A(e){let{children:t}=e,[a,l]=(0,r.useReducer)(E,I),o=(0,r.useRef)(new m),i=(0,r.useRef)(new x),s=(0,r.useRef)(new k),c=(0,r.useRef)(null),d=(0,r.useRef)({active:!1,startTime:0,duration:400,scanlineY:0}),h=(0,r.useRef)(new Map),u=(0,r.useRef)(new Map);return(0,r.useEffect)(()=>{if(a.data&&(h.current=function(e){let t=new Map,a=e.length,n=Math.ceil(Math.sqrt(a));for(let r=0;r<a;r++){let a=Math.floor(r/n),l=r%n;t.set(e[r],{gridX:3*l+1,gridY:3*a+1})}return t}(_(a.data.agent_snapshots)),u.current=function(e){let t=new Map;for(let a of e)t.has(a.epoch)||t.set(a.epoch,new Map),t.get(a.epoch).set(a.agent_id,a);return t}(a.data.agent_snapshots),o.current.clear(),i.current.clear(),s.current.clear(),c.current=null,h.current.size>0)){let e=1/0,t=1/0,n=-1/0,r=-1/0;for(let a of h.current.values()){let l=j(a.gridX,a.gridY);e=Math.min(e,l.x),t=Math.min(t,l.y-120),n=Math.max(n,l.x),r=Math.max(r,l.y+30)}l({type:"SET_VIEWPORT",viewport:C(a.viewport,e,t,n,r)})}},[a.data]),(0,n.jsx)(R.Provider,{value:{state:a,dispatch:l,interactionSystem:o,particleSystem:i,codeTrailSystem:s,digitalRainRef:c,recompileStateRef:d,agentPositions:h,agentsByEpoch:u},children:t})}function N(){var e,t;let{state:a,dispatch:n,codeTrailSystem:l,digitalRainRef:o,recompileStateRef:i}=(0,r.useContext)(R);return{...a,agentSnapshots:null!=(t=null==(e=a.data)?void 0:e.agent_snapshots)?t:[],loadData:e=>n({type:"LOAD_DATA",data:e}),setHovered:e=>n({type:"SET_HOVERED",agentId:e}),setSelected:e=>n({type:"SET_SELECTED",agentId:e}),toggleOverlay:e=>n({type:"TOGGLE_OVERLAY",key:e}),codeTrailSystem:l,digitalRainRef:o,recompileStateRef:i}}function D(){let{state:e,dispatch:t,agentPositions:a}=(0,r.useContext)(R),n=(0,r.useCallback)(e=>t({type:"SET_VIEWPORT",viewport:e}),[t]),o=(0,r.useCallback)((t,a)=>{var r;n((r=e.viewport,{...r,x:r.x+t,y:r.y+a}))},[e.viewport,n]),i=(0,r.useCallback)((t,a,r)=>{n(function(e,t,a,n){let r=l(e.zoom*(1-.001*t),.3,4),o=r/e.zoom;return{...e,zoom:r,x:a-(a-e.x)*o,y:n-(n-e.y)*o}}(e.viewport,t,a,r))},[e.viewport,n]),s=(0,r.useCallback)(()=>{if(0===a.current.size){var t;return void n({...t=e.viewport,x:t.width/2-0*t.zoom,y:t.height/2-0*t.zoom})}let r=1/0,l=1/0,o=-1/0,i=-1/0;for(let e of a.current.values()){let t=j(e.gridX,e.gridY);r=Math.min(r,t.x),l=Math.min(l,t.y-100),o=Math.max(o,t.x),i=Math.max(i,t.y+20)}n(C(e.viewport,r,l,o,i))},[e.viewport,n,a]),c=(0,r.useCallback)((e,a)=>{t({type:"RESIZE",width:e,height:a})},[t]);return{viewport:e.viewport,handlePan:o,handleZoom:i,resetCamera:s,resize:c}}function B(e){let t=parseInt(e.replace("#",""),16);return{r:t>>16&255,g:t>>8&255,b:255&t}}function W(e,t,a){var n,r,o,i;let s=B(e),c=B(t);return i=(n=s.r)+(c.r-n)*a,"#"+[i,(r=s.g)+(c.g-r)*a,(o=s.b,o+(c.b-o)*a)].map(e=>l(Math.round(e),0,255).toString(16).padStart(2,"0")).join("")}function L(e,t){let{r:a,g:n,b:r}=B(e);return"rgba(".concat(a,",").concat(n,",").concat(r,",").concat(t,")")}function Y(e){let t=l(e,0,1);return t<.5?W("#EB5757","#F2C94C",2*t):W("#F2C94C","#27AE60",(t-.5)*2)}let z="/game-app",X=["honest","opportunistic","deceptive","adversarial","rlm","crewai"],q=["tile","tower","spire","node"];class O{init(){if(!this.initialized){for(let e of(this.initialized=!0,X)){let t=new Image,a={img:t,cleaned:null,loaded:!1};t.onload=()=>{a.cleaned=this.removeBackground(t),a.loaded=!0},t.onerror=()=>{},t.src="".concat(z,"/sprites/").concat(e,"_idle.png"),this.sprites.set(e,a)}for(let e of q){let t=new Image,a={img:t,cleaned:null,loaded:!1};t.onload=()=>{let e=this.removeBackground(t);a.cleaned=this.trimTransparent(e),a.loaded=!0},t.onerror=()=>{},t.src="".concat(z,"/sprites/").concat(e,".png"),this.envSprites.set(e,a)}}}isReady(e){var t;let a=this.sprites.get(e);return null!=(t=null==a?void 0:a.loaded)&&t}removeBackground(e){let t=document.createElement("canvas"),a=e.naturalWidth,n=e.naturalHeight;t.width=a,t.height=n;let r=t.getContext("2d");r.drawImage(e,0,0);let l=r.getImageData(0,0,a,n),o=l.data,i=new Uint8Array(a*n),s=0,c=0,d=0;for(let[e,t]of[[2,2],[a-3,2],[2,n-3],[a-3,n-3]]){let n=(t*a+e)*4;s+=o[n],c+=o[n+1],d+=o[n+2]}s/=4,c/=4,d/=4;let h=e=>{let t=o[e],a=o[e+1],n=o[e+2],r=o[e+3];return!!(0===r||120>Math.sqrt((t-s)**2+(a-c)**2+(n-d)**2))||!!(r<180)},u=[];for(let e=0;e<a;e++)for(let t of[0,n-1]){let n=t*a+e;!i[n]&&h(4*n)&&(u.push(n),i[n]=1)}for(let e=1;e<n-1;e++)for(let t of[0,a-1]){let n=e*a+t;!i[n]&&h(4*n)&&(u.push(n),i[n]=1)}let f=0;for(;f<u.length;){let e=u[f++],t=e%a,r=Math.floor(e/a);for(let l of(o[4*e+3]=0,[r>0?e-a:-1,r<n-1?e+a:-1,t>0?e-1:-1,t<a-1?e+1:-1]))l>=0&&!i[l]&&h(4*l)&&(i[l]=1,u.push(l))}let p=new Uint8Array(a*n);for(let e=0;e<a*n;e++)p[e]=o[4*e+3];for(let e=1;e<n-1;e++)for(let t=1;t<a-1;t++){let n=e*a+t;if(0===p[n])continue;let r=0;0===p[n-1]&&r++,0===p[n+1]&&r++,0===p[n-a]&&r++,0===p[n+a]&&r++,r>=2?o[4*n+3]=Math.round(.5*o[4*n+3]):1===r&&(o[4*n+3]=Math.round(.8*o[4*n+3]))}return r.putImageData(l,0,0),t}trimTransparent(e){let t=e.width,a=e.height,n=e.getContext("2d").getImageData(0,0,t,a).data,r=a,l=0,o=t,i=0;for(let e=0;e<a;e++)for(let a=0;a<t;a++)n[(e*t+a)*4+3]>0&&(e<r&&(r=e),e>l&&(l=e),a<o&&(o=a),a>i&&(i=a));if(r>l||o>i)return e;let s=i-o+1,c=l-r+1,d=document.createElement("canvas");return d.width=s,d.height=c,d.getContext("2d").drawImage(e,o,r,s,c,0,0,s,c),d}draw(e,t,a,n,r,l){let o=this.sprites.get(t);if(!(null==o?void 0:o.loaded)||!o.cleaned)return!1;let i=o.cleaned,s=48*r,c=84*r;return e.save(),l>0&&(e.translate(a,0),e.scale(-1,1),e.translate(-a,0)),e.drawImage(i,0,0,i.width,i.height,a-s/2,n-c,s,c),e.restore(),!0}drawTile(e,t,a,n,r){let l=this.envSprites.get("tile");if(!(null==l?void 0:l.loaded)||!l.cleaned)return!1;let o=l.cleaned;return e.drawImage(o,0,0,o.width,o.height,t-n/2,a-r/2,n,r),!0}drawBuilding(e,t,a,n,r,l){let o=this.envSprites.get(t);if(!(null==o?void 0:o.loaded)||!o.cleaned)return!1;let i=o.cleaned;return e.drawImage(i,0,0,i.width,i.height,a-r/2,n-l,r,l),!0}constructor(){this.sprites=new Map,this.envSprites=new Map,this.initialized=!1}}let G=new O;G.init();let H={honest:"#4AE8A0",opportunistic:"#F5C84C",deceptive:"#D084F5",adversarial:"#FF6B6B",rlm:"#5BC8FF",crewai:"#7BF590"},V={honest:"#FFD966",opportunistic:"#FFB347",deceptive:"#FF80FF",adversarial:"#FF4444",rlm:"#80D4FF",crewai:"#FFEE80"};function Q(e,t,a,n,r,l){let o=u.baseWidth*l,i=u.baseHeight*l,s=o/2,c=a-i,d=.36*s,h=c+d+.03*i,f=c+.26*i;switch(n){case"honest":var p,g,m,x,y,v=e,b=t,S=h,M=d,w=r;let P=S-1.4*M,T=.2*Math.sin(.003*Date.now());v.strokeStyle=L(w.accent,.25+T),v.lineWidth=4,v.beginPath(),v.ellipse(b,P,.9*M,.28*M,0,0,2*Math.PI),v.stroke(),v.strokeStyle=L(w.accent,.6+T),v.lineWidth=1.5,v.beginPath(),v.ellipse(b,P,.9*M,.28*M,0,0,2*Math.PI),v.stroke();break;case"opportunistic":!function(e,t,a,n,r,l,o){let i=.002*Date.now(),s=(l+a)*.5;for(let a=0;a<4;a++){let r=i+2*Math.PI/4*a,l=t+Math.cos(r)*n*.8,c=s+Math.sin(r)*n*.3,d=.5+.2*Math.sin(i+a);e.fillStyle=L(o.accent,.3*d),e.beginPath(),e.arc(l,c,4,0,2*Math.PI),e.fill(),e.fillStyle=L(o.accent,d),e.beginPath(),e.arc(l,c,2,0,2*Math.PI),e.fill()}}(e,t,a,s,0,f,r);break;case"deceptive":p=e,g=t,m=h,x=d,p.strokeStyle=L((y=r).accent,.5),p.lineWidth=1.2,p.beginPath(),p.moveTo(g-.75*x,m-.2*x),p.quadraticCurveTo(g,m-.5*x,g+.75*x,m-.2*x),p.lineTo(g+.55*x,m+.18*x),p.quadraticCurveTo(g,m+.12*x,g-.55*x,m+.18*x),p.closePath(),p.stroke(),p.fillStyle=L(y.secondary,.08),p.fill();break;case"adversarial":var k=e,_=t,C=h,j=d,F=f,I=s,E=r;k.lineWidth=2;let R=k.createLinearGradient(_-.6*j,C,_-1.2*j,C-1.8*j);R.addColorStop(0,L(E.secondary,.3)),R.addColorStop(1,L(E.secondary,.9)),k.strokeStyle=R,k.beginPath(),k.moveTo(_-.6*j,C-.5*j),k.lineTo(_-1.2*j,C-1.8*j),k.stroke();let A=k.createLinearGradient(_+.6*j,C,_+1.2*j,C-1.8*j);A.addColorStop(0,L(E.secondary,.3)),A.addColorStop(1,L(E.secondary,.9)),k.strokeStyle=A,k.beginPath(),k.moveTo(_+.6*j,C-.5*j),k.lineTo(_+1.2*j,C-1.8*j),k.stroke(),k.fillStyle=L(E.secondary,.9),k.beginPath(),k.arc(_-1.2*j,C-1.8*j,2,0,2*Math.PI),k.fill(),k.beginPath(),k.arc(_+1.2*j,C-1.8*j,2,0,2*Math.PI),k.fill(),k.strokeStyle=L(E.accent,.5),k.lineWidth=1.2,k.beginPath(),k.moveTo(_-.5*I,F),k.lineTo(_-.75*I,F-.35*I),k.stroke(),k.beginPath(),k.moveTo(_+.5*I,F),k.lineTo(_+.75*I,F-.35*I),k.stroke();break;case"rlm":var N=e,D=t,B=h,W=d,Y=f,z=s,X=i,q=r;N.strokeStyle=L(q.accent,.7),N.lineWidth=1.5,N.beginPath(),N.moveTo(D,B-W),N.lineTo(D,B-2*W),N.stroke();let O=.4*Math.sin(.005*Date.now())+.6;N.fillStyle=L(q.accent,O),N.beginPath(),N.arc(D,B-2*W,2.5,0,2*Math.PI),N.fill(),N.strokeStyle=L(q.accent,.3*O),N.lineWidth=3,N.beginPath(),N.arc(D,B-2*W,5,0,2*Math.PI),N.stroke(),N.strokeStyle=L(q.accent,.5),N.lineWidth=1,N.beginPath(),N.rect(D-.7*W,B-.12*W,1.4*W,.24*W),N.stroke(),N.fillStyle=L(q.secondary,.12),N.fill(),N.strokeStyle=L(q.accent,.3),N.lineWidth=.7;let G=Y+.12*X;N.beginPath(),N.moveTo(D-.35*z,G),N.lineTo(D+.35*z,G),N.moveTo(D-.15*z,G),N.lineTo(D-.15*z,G+.08*X),N.moveTo(D+.15*z,G),N.lineTo(D+.15*z,G+.08*X),N.moveTo(D,G),N.lineTo(D,G+.1*X),N.stroke(),N.fillStyle=L(q.accent,.6),N.beginPath(),N.arc(D-.15*z,G+.08*X,1.5,0,2*Math.PI),N.fill(),N.beginPath(),N.arc(D+.15*z,G+.08*X,1.5,0,2*Math.PI),N.fill(),N.beginPath(),N.arc(D,G+.1*X,1.5,0,2*Math.PI),N.fill();break;case"crewai":var H=e,V=t,Q=h,U=d,K=f,Z=s,$=i,J=r;H.strokeStyle=L(J.accent,.6),H.lineWidth=1.5,H.beginPath(),H.arc(V,Q-.2*U,1.1*U,Math.PI,0),H.stroke(),H.beginPath(),H.moveTo(V-1.3*U,Q-.2*U),H.lineTo(V+1.3*U,Q-.2*U),H.stroke();let ee=K+.25*$;H.strokeStyle=L(J.accent,.45),H.lineWidth=1.2,H.beginPath(),H.moveTo(V-.4*Z,ee),H.lineTo(V+.4*Z,ee),H.stroke(),H.fillStyle=L(J.accent,.7),H.beginPath(),H.arc(V,ee,2,0,2*Math.PI),H.fill(),H.fillStyle=L(J.accent,.4),H.beginPath(),H.arc(V-.2*Z,ee,1.2,0,2*Math.PI),H.fill(),H.beginPath(),H.arc(V+.2*Z,ee,1.2,0,2*Math.PI),H.fill()}}function U(e,t,a,n,r,l,o){let i=1-o;return{x:i*i*e+2*i*o*a+o*o*r,y:i*i*t+2*i*o*n+o*o*l}}function K(e,t,a){let n=e=>{let t=e.replace("#","");return[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]},[r,l,o]=n(e),[i,s,c]=n(t),d=Math.round(r+(i-r)*a),h=Math.round(l+(s-l)*a),u=Math.round(o+(c-o)*a);return"rgb(".concat(d,",").concat(h,",").concat(u,")")}function Z(e){let t=0|e;return()=>{let e=Math.imul((t=t+0x6d2b79f5|0)^t>>>15,1|t);return(((e=e+Math.imul(e^e>>>7,61|e)^e)^e>>>14)>>>0)/0x100000000}}let $=null,J=-1,ee=[{label:"Posts",color:c.info,getValue:e=>e.total_posts,offsetX:-18},{label:"Votes",color:c.secondary,getValue:e=>e.total_votes,offsetX:0},{label:"Tasks",color:c.accent,getValue:e=>e.total_tasks_completed,offsetX:18}];function et(){let e=(0,r.useRef)(null),{agents:t,arcs:a,viewport:i,hoveredAgent:h,selectedAgent:f,currentEpochSnap:m,environment:x,overlays:y,particles:v,gridSize:S,setHovered:k,setSelected:_,codeTrailSystem:C,digitalRainRef:I,recompileStateRef:E}=N(),{handlePan:R,handleZoom:A,resetCamera:B,resize:z}=D(),X=(0,r.useRef)(!1),q=(0,r.useRef)({x:0,y:0});(0,r.useEffect)(()=>{let t=e.current;if(!t)return;let a=t.parentElement;if(!a)return;let n=new ResizeObserver(e=>{for(let a of e){let{width:e,height:n}=a.contentRect;t.width=e*devicePixelRatio,t.height=n*devicePixelRatio,t.style.width=e+"px",t.style.height=n+"px",z(e,n)}});return n.observe(a),()=>n.disconnect()},[z]),(0,r.useEffect)(()=>{let n=e.current;if(!n)return;let r=n.getContext("2d");r&&(r.save(),r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high",r.scale(devicePixelRatio,devicePixelRatio),function(e,t){let a=t.viewport.width,n=t.viewport.height;e.clearRect(0,0,a,n),function(e,t,a,n){let r=e.createLinearGradient(0,0,0,.7*a),l=Math.min(1,Math.max(0,n)),o=K("#0D1117","#3D1020",l),i=K("#0D1117","#1A0A10",.7*l);r.addColorStop(0,o),r.addColorStop(1,i),e.fillStyle=r,e.fillRect(0,0,t,a),l>.6&&(e.fillStyle=L("#EB5757",(l-.6)*.15*(.5*Math.sin(Date.now()/200)+.5)),e.fillRect(0,0,t,.3*a))}(e,a,n,t.environment.threatLevel),t.overlays.digitalRain&&t.digitalRain&&function(e,t,a,n,r){e.save(),e.font="bold 14px 'Courier New', monospace",e.textAlign="center";let o=l(r,0,1),i=Math.max(0,.4-.4*o);for(let a=0;a<t.columns.length;a++){if(i>0&&7*a%10/10<i)continue;let r=t.columns[a],l=r.chars;for(let t=0;t<l.length;t++){let a=r.headY-t*r.charInterval;if(a<-20||a>n+20)continue;let i=0===t,s=1-t/l.length,c=s*s;if(i)e.fillStyle=o>.5?"rgba(255,".concat(Math.round(180-100*o),",").concat(Math.round(80-60*o),",").concat(.95*r.brightness,")"):"rgba(200,255,220,".concat(.9*r.brightness,")");else{let t=c*r.brightness*.6;if(o>.3){let a=(o-.3)/.7,n=Math.round(200*a),r=Math.round(255*(1-.5*a));e.fillStyle="rgba(".concat(n,",").concat(r,",65,").concat(t,")")}else e.fillStyle=w(t)}e.fillText(l[t],r.x,a)}}e.restore()}(e,t.digitalRain,0,n,t.environment.threatLevel),e.save(),e.translate(t.viewport.x,t.viewport.y),e.scale(t.viewport.zoom,t.viewport.zoom);let r=t.environment.reputationStd+t.environment.payoffStd;if(!function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;for(let r=0;r<t;r++)for(let l=0;l<t;l++)!function(e,t,a){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,{x:l,y:o}=j(t,a),i=n>.3,s=n>.5?"#EB5757":c.accent,d=G.drawTile(e,l,o,96,48);if(!d){F(e,l,o,96,48);let t=e.createLinearGradient(l-48,o,l+48,o);if(i){let e=.12*n;t.addColorStop(0,"rgba(".concat(Math.round(20+200*e),", ").concat(Math.round(8),", ").concat(Math.round(14+30*e),", 0.92)")),t.addColorStop(1,"rgba(".concat(Math.round(12+150*e),", ").concat(Math.round(6),", ").concat(Math.round(10+20*e),", 0.92)"))}else t.addColorStop(0,"rgba(10, 14, 22, 0.92)"),t.addColorStop(1,"rgba(6, 10, 16, 0.92)");e.fillStyle=t,e.fill(),F(e,l,o,96,48),e.strokeStyle=L(s,i?.18:.35),e.lineWidth=.6,e.stroke();let a=i?.1:.2;e.strokeStyle=L(s,a),e.lineWidth=.4,e.beginPath(),e.moveTo(l-24,o),e.lineTo(l+24,o),e.stroke(),e.beginPath(),e.moveTo(l,o-12),e.lineTo(l,o+12),e.stroke(),e.strokeStyle=L(s,.6*a),e.lineWidth=.3,F(e,l,o,48,24),e.stroke(),e.strokeStyle=L(s,.4*a),e.lineWidth=.3,e.beginPath(),e.moveTo(l-12,o-6),e.lineTo(l-28.799999999999997,o-2.4000000000000004),e.stroke(),e.beginPath(),e.moveTo(l+12,o-6),e.lineTo(l+28.799999999999997,o-2.4000000000000004),e.stroke(),e.beginPath(),e.moveTo(l-12,o+6),e.lineTo(l-28.799999999999997,o+2.4000000000000004),e.stroke(),e.beginPath(),e.moveTo(l+12,o+6),e.lineTo(l+28.799999999999997,o+2.4000000000000004),e.stroke();let r=i?.2:.4;e.fillStyle=L(s,r),e.beginPath(),e.arc(l,o,1.2,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(l,o-12,.96,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(l,o+12,.96,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(l-24,o,.96,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(l+24,o,.96,0,2*Math.PI),e.fill(),e.fillStyle=L(s,.6*r);e.beginPath(),e.arc(l,o-6,.72,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(l,o+6,.72,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(l-12,o,.72,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(l+12,o,.72,0,2*Math.PI),e.fill()}if(i&&d&&(F(e,l,o,96,48),e.fillStyle=L("#EB5757",.15*n),e.fill()),r>.1){let t=Math.min((r-.1)/.8,1);F(e,l,o,96,48),e.fillStyle=L(t>.5?"#BB6BD9":"#F2994A",.08*t),e.fill()}}(e,r,l,a,n)}(e,t.gridSize,t.environment.toxicity,r),!function(e,t,a){let n;if(a<.2)return;let r=Math.min((a-.2)/.6,1),l=Math.floor(8*r)+1;e.save(),e.strokeStyle=L("#EB5757",.4*r),e.lineWidth=1;let o=(n=42,()=>{let e=Math.imul((n=n+0x6d2b79f5|0)^n>>>15,1|n);return(((e=e+Math.imul(e^e>>>7,61|e)^e)^e>>>14)>>>0)/0x100000000});for(let a=0;a<l;a++){let{x:a,y:n}=j(o()*t,o()*t);e.beginPath(),e.moveTo(a,n);let r=a,l=n,i=3+Math.floor(4*o());for(let t=0;t<i;t++)r+=(o()-.5)*40,l+=(o()-.5)*28,e.lineTo(r,l);e.stroke()}e.restore()}(e,t.gridSize,t.environment.giniCoefficient),t.overlays.networkWeb&&function(e,t,a,n){if(a<.5||t.length<2)return;let r=Math.round(a),l=t.map(e=>{let t=j(e.gridX,e.gridY);return{x:t.x+e.walkOffsetX,y:t.y+e.walkOffsetY}}),o=(e,t)=>{let a=l[e].x-l[t].x,n=l[e].y-l[t].y;return a*a+n*n},i=new Set,s=t.map(()=>new Set);for(let e=0;e<t.length;e++){let a=[];for(let n=0;n<t.length;n++)e!==n&&a.push({idx:n,d:o(e,n)});a.sort((e,t)=>e.d-t.d);let n=Math.min(r,a.length);for(let t=0;t<n;t++){let n=a[t].idx,r=e<n?"".concat(e,":").concat(n):"".concat(n,":").concat(e);i.add(r),s[e].add(n),s[n].add(e)}}let d=.15+.45*n;for(let t of(e.save(),e.strokeStyle=L(c.accent,d),e.lineWidth=1.2,e.setLineDash([4,6]),i)){let[a,n]=t.split(":"),r=Number(a),o=Number(n);e.beginPath(),e.moveTo(l[r].x,l[r].y),e.lineTo(l[o].x,l[o].y),e.stroke()}if(e.setLineDash([]),n>.5){e.fillStyle=L(c.accent,(n-.5)*.12);let t=new Set;for(let a of i){let[n,r]=a.split(":"),o=Number(n),i=Number(r);for(let a of s[o])if(a!==i&&s[i].has(a)){let n=[o,i,a].sort((e,t)=>e-t),r=n.join(":");if(t.has(r))continue;t.add(r),e.beginPath(),e.moveTo(l[n[0]].x,l[n[0]].y),e.lineTo(l[n[1]].x,l[n[1]].y),e.lineTo(l[n[2]].x,l[n[2]].y),e.closePath(),e.fill()}}}for(let t of(e.fillStyle=L(c.accent,d+.15),e.strokeStyle=L(c.accent,d+.25),e.lineWidth=.8,l))e.beginPath(),e.moveTo(t.x,t.y-3),e.lineTo(t.x+3,t.y),e.lineTo(t.x,t.y+3),e.lineTo(t.x-3,t.y),e.closePath(),e.fill(),e.stroke();e.restore()}(e,t.agents,t.environment.avgDegree,t.environment.avgClustering),t.overlays.threatZones){for(let a of t.agents)if("adversarial"===a.agentType||"deceptive"===a.agentType){let n=j(a.gridX,a.gridY);!function(e,t,a,n,r){if(n<.2)return;let l=.7+.3*Math.sin(2*(Date.now()/1e3)),o=30+20*n,i="adversarial"===r?"#EB5757":"#BB6BD9",s=e.createRadialGradient(t,a,0,t,a,o*l);s.addColorStop(0,L(i,.15*n)),s.addColorStop(.6,L(i,.08*n)),s.addColorStop(1,L(i,0)),e.fillStyle=s,e.beginPath(),e.arc(t,a,o*l,0,2*Math.PI),e.fill()}(e,n.x,n.y,t.environment.threatLevel,a.agentType),function(e,t,a,n,r,l){if(n<1)return;let o=Date.now()/1e3,i=Math.min(Math.floor(n),5),s=.8+.3*Math.min(r,5),c="adversarial"===l?"#EB5757":"#BB6BD9";e.save(),e.lineWidth=1;for(let n=0;n<i;n++){let r=(o*s+.6*n)%2;if(r>1)continue;let l=20+40*r*(1+.3*n),i=(1-r)*.25;e.beginPath(),e.ellipse(t,a,l,.5*l,0,0,2*Math.PI),e.strokeStyle=L(c,i),e.stroke()}e.restore()}(e,n.x,n.y,t.environment.contagionDepth,t.environment.activeThreats,a.agentType)}}t.codeTrails.length>0&&function(e,t){if(0!==t.length){for(let a of(e.save(),e.textAlign="center",t))a.alpha<=0||(e.font="bold ".concat(a.fontSize,"px 'Courier New', monospace"),e.fillStyle=a.color.replace(/[\d.]+\)$/,"".concat(a.alpha,")")),e.fillText(a.char,a.x,a.y));e.restore()}}(e,t.codeTrails);let i=[],h=new Map(t.agents.map(e=>[e.id,e])),f=t.recompileState;for(let e of t.agents)if(i.push(function(e,t){return{depth:e.gridX+e.gridY,render:a=>(function(e,t,a){var n,r,o;let i=j(t.gridX,t.gridY),s=i.x+t.walkOffsetX,c=i.y+t.walkOffsetY,h=d[t.agentType],f=t.scale;e.save(),function(e,t,a,n,r){if(n<=0)return;let o=function(e,t,a,n,r){return 0+30*l((e-0)/200,0,1)}(n,0,0,0,0);if(o<=2)return;let i=e.createRadialGradient(t,a,0,t,a,48+o);i.addColorStop(0,L(r.secondary,.3)),i.addColorStop(1,L(r.secondary,0)),e.fillStyle=i,e.beginPath(),e.ellipse(t,a,48+o,24+o/2,0,0,2*Math.PI),e.fill()}(e,s,c,t.resources,h),function(e,t,a,n,r,o){if(.5>=Math.abs(n))return;let i=u.baseHeight*r,s=n>0,c=l(Math.abs(n)/10,0,.5),d=s?"#F2C94C":"#1A1A2E",h=a-.5*i,f=e.createRadialGradient(t,h,0,t,h,76.80000000000001);f.addColorStop(0,L(d,c)),f.addColorStop(1,L(d,0)),e.fillStyle=f,e.beginPath(),e.ellipse(t,h,76.80000000000001,46.080000000000005,0,0,2*Math.PI),e.fill()}(e,s,c,t.totalPayoff,f,0),t.isQuarantined&&(n=e,r=s,o=c,n.strokeStyle=L("#EB5757",.6+.3*Math.sin(Date.now()/300)),n.lineWidth=2,n.setLineDash([6,4]),n.beginPath(),n.ellipse(r,o,57.599999999999994,28.799999999999997,0,0,2*Math.PI),n.stroke(),n.setLineDash([]));let g=Math.sqrt(t.walkOffsetX**2+t.walkOffsetY**2),m=g>.5,x=t.facing,y=p[t.agentType],v=0;if(m){let e=Math.min(1,g/80),a=Math.sin(2*t.walkPhase);v=Math.abs(a+y.bobAsymmetry*a*a)*y.bobAmplitude*f*e}else v=y.idleBob*Math.sin(.0012*Date.now())*f;if(G.draw(e,t.agentType,s,c-v,f,x)){let a=c-v;e.save(),e.translate(s,0),e.scale(x,1),e.translate(-s,0),Q(e,s,a,t.agentType,h,f),e.restore()}else e.save(),e.translate(s,0),e.scale(x,1),e.translate(-s,0),function(e,t,a,n,r,l){let o,i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]&&arguments[7],c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,d=p[n],h=u.baseWidth*l,f=u.baseHeight*l,g=h/2,m=Math.min(1,c/80);if(s){let e=Math.sin(2*i);o=Math.abs(e+d.bobAsymmetry*e*e)*d.bobAmplitude*l*m}else o=d.idleBob*Math.sin(.0012*Date.now())*l;let x=a-o-f,y=x+.22*f,v=x+.26*f,b=x+.38*f,S=x+.52*f,M=x+.58*f,w=x+.78*f,P=a-.04*f,T=s?Math.sin(i)*g*.14*d.legSwingScale*m:0,k=s?-(.18*Math.sin(i))*d.armSwingScale*m:0,_=Date.now(),C=e.createRadialGradient(t,a+3,0,t,a+3,1.2*g);C.addColorStop(0,L(r.secondary,.22)),C.addColorStop(.5,L(r.secondary,.08)),C.addColorStop(1,L(r.secondary,0)),e.fillStyle=C,e.beginPath(),e.ellipse(t,a+3,+g,.28*g,0,0,2*Math.PI),e.fill();let j=e.createLinearGradient(t-.25*g,M,t-.15*g,a);j.addColorStop(0,"#0E0E18"),j.addColorStop(.5,"#0A0A12"),j.addColorStop(1,"#060610"),e.fillStyle=j,e.beginPath(),e.moveTo(t-.22*g,M),e.quadraticCurveTo(t-.28*g,w,t-.3*g+T,a),e.lineTo(t-.02*g+T,a),e.quadraticCurveTo(t-.04*g,w,t-.02*g,M),e.closePath(),e.fill(),e.strokeStyle=L(r.secondary,.12),e.lineWidth=.6,e.beginPath(),e.moveTo(t-.22*g,M),e.quadraticCurveTo(t-.28*g,w,t-.3*g+T,a),e.stroke(),e.fillStyle="#060610",e.beginPath(),e.moveTo(t+.02*g,M),e.quadraticCurveTo(t+.04*g,w,t+.02*g-T,a),e.lineTo(t+.3*g-T,a),e.quadraticCurveTo(t+.28*g,w,t+.22*g,M),e.closePath(),e.fill(),e.fillStyle=L(r.secondary,.2),e.beginPath(),e.ellipse(t-.15*g+T,a-1,.16*g,2,0,0,2*Math.PI),e.fill(),e.beginPath(),e.ellipse(t+.15*g-T,a-1,.16*g,2,0,0,2*Math.PI),e.fill();let F=e.createLinearGradient(t-.35*g,v,t+.35*g,S);F.addColorStop(0,"#10101A"),F.addColorStop(.5,"#0A0A14"),F.addColorStop(1,"#060610"),e.fillStyle=F,e.beginPath(),e.moveTo(t-.38*g,v),e.lineTo(t+.38*g,v),e.lineTo(t+.28*g,S),e.quadraticCurveTo(t,S+2,t-.28*g,S),e.closePath(),e.fill();let I=Math.sin(.002*_+.01*t)*g*.05,E=Math.sin(.004*_+.02*t)*g*.02,R=e.createLinearGradient(t,v-4,t,P);R.addColorStop(0,L(r.secondary,.4)),R.addColorStop(.3,L(r.secondary,.3)),R.addColorStop(.7,L(r.secondary,.2)),R.addColorStop(1,L(r.secondary,.08)),e.fillStyle=R,e.beginPath(),e.moveTo(t-.48*g,v-2),e.lineTo(t+.48*g,v-2),e.quadraticCurveTo(t+.9*g+I,b,t+.85*g+I,S),e.quadraticCurveTo(t+.88*g+I+E,M,t+.82*g+I,P),e.lineTo(t-.82*g-I,P),e.quadraticCurveTo(t-.88*g-I-E,M,t-.85*g-I,S),e.quadraticCurveTo(t-.9*g-I,b,t-.48*g,v-2),e.closePath(),e.fill();let A=e.createLinearGradient(t,v,t,P);A.addColorStop(0,L(r.primary,.2)),A.addColorStop(1,L(r.primary,.05)),e.fillStyle=A,e.beginPath(),e.moveTo(t-.1*g,v+.06*f),e.lineTo(t+.1*g,v+.06*f),e.lineTo(t+.25*g+.5*I,P),e.lineTo(t-.25*g-.5*I,P),e.closePath(),e.fill(),e.fillStyle=L(r.secondary,.5),e.beginPath(),e.moveTo(t-.38*g,v-4),e.quadraticCurveTo(t-.45*g,v-6,t-.42*g,y),e.lineTo(t-.2*g,y+2),e.lineTo(t-.28*g,v-2),e.closePath(),e.fill(),e.beginPath(),e.moveTo(t+.38*g,v-4),e.quadraticCurveTo(t+.45*g,v-6,t+.42*g,y),e.lineTo(t+.2*g,y+2),e.lineTo(t+.28*g,v-2),e.closePath(),e.fill(),e.lineWidth=1.4,e.strokeStyle=L(r.secondary,.55),e.beginPath(),e.moveTo(t-.48*g,v-2),e.quadraticCurveTo(t-.9*g-I,b,t-.85*g-I,S),e.quadraticCurveTo(t-.88*g-I,M,t-.82*g-I,P),e.stroke(),e.beginPath(),e.moveTo(t+.48*g,v-2),e.quadraticCurveTo(t+.9*g+I,b,t+.85*g+I,S),e.quadraticCurveTo(t+.88*g+I,M,t+.82*g+I,P),e.stroke(),e.lineWidth=.8,e.strokeStyle=L(r.secondary,.3),e.beginPath(),e.moveTo(t-.82*g-I,P),e.lineTo(t+.82*g+I,P),e.stroke(),e.strokeStyle=L(r.secondary,.35),e.lineWidth=.6,e.beginPath(),e.moveTo(t,v+.04*f),e.lineTo(t,P),e.stroke(),e.lineWidth=.5,e.strokeStyle=L(r.secondary,.25),e.beginPath(),e.moveTo(t-.05*g,v+.04*f),e.lineTo(t-.15*g,b),e.stroke(),e.beginPath(),e.moveTo(t+.05*g,v+.04*f),e.lineTo(t+.15*g,b),e.stroke(),e.strokeStyle=L(r.secondary,.1),e.lineWidth=.4;let N=.04*f,D=.001*_;for(let a=v+N;a<P;a+=N){let n=(a-v)/(P-v),l=.02*Math.sin(D+6*n),o=g*(.48+.34*n+l),i=.06+.04*Math.sin(.005*_+10*n);e.strokeStyle=L(r.secondary,i),e.beginPath(),e.moveTo(t-o,a),e.lineTo(t+o,a),e.stroke()}e.save();let B=.002*_;for(let a=0;a<6;a++){let n=(.8*B+1.3*a)%2.5;if(n>1)continue;let o=v+(.19*a+.07*B)%1*(P-v),i=t+Math.sin(2.7*a+.0015*_)*g*.5,s=(1+.5*Math.sin(3.1*a+.003*_))*l;e.globalAlpha=.7*Math.sin(n*Math.PI),e.fillStyle=r.accent,e.beginPath(),e.arc(i,o,s,0,2*Math.PI),e.fill()}e.globalAlpha=1,e.restore();let W=t+.72*g-k*g,Y=v+.26*f,z=e.createLinearGradient(t+.45*g,v,W,Y);z.addColorStop(0,L(r.secondary,.3)),z.addColorStop(1,L(r.secondary,.15)),e.fillStyle=z,e.beginPath(),e.moveTo(t+.45*g,v),e.quadraticCurveTo(t+.6*g,v+.1*f,W,Y),e.lineTo(W-.12*g,Y+.02*f),e.quadraticCurveTo(t+.5*g,v+.12*f,t+.35*g,v+.04*f),e.closePath(),e.fill(),e.strokeStyle=L(r.secondary,.3),e.lineWidth=.7,e.beginPath(),e.moveTo(t+.45*g,v),e.quadraticCurveTo(t+.6*g,v+.1*f,W,Y),e.stroke();let X=e.createRadialGradient(W-.06*g,Y,0,W-.06*g,Y,4*l);X.addColorStop(0,L(V[n],.7)),X.addColorStop(1,L(V[n],0)),e.fillStyle=X,e.beginPath(),e.arc(W-.06*g,Y,4*l,0,2*Math.PI),e.fill(),e.fillStyle=L(V[n],.8),e.beginPath(),e.arc(W-.06*g,Y,1.8*l,0,2*Math.PI),e.fill();let q=t-.72*g+k*g,O=v+.26*f,G=e.createLinearGradient(t-.45*g,v,q,O);G.addColorStop(0,L(r.secondary,.35)),G.addColorStop(1,L(r.secondary,.18)),e.fillStyle=G,e.beginPath(),e.moveTo(t-.45*g,v),e.quadraticCurveTo(t-.6*g,v+.1*f,q,O),e.lineTo(q+.12*g,O+.02*f),e.quadraticCurveTo(t-.5*g,v+.12*f,t-.35*g,v+.04*f),e.closePath(),e.fill(),e.strokeStyle=L(r.secondary,.35),e.lineWidth=.7,e.beginPath(),e.moveTo(t-.45*g,v),e.quadraticCurveTo(t-.6*g,v+.1*f,q,O),e.stroke();let Q=e.createRadialGradient(q+.06*g,O,0,q+.06*g,O,4*l);Q.addColorStop(0,L(V[n],.7)),Q.addColorStop(1,L(V[n],0)),e.fillStyle=Q,e.beginPath(),e.arc(q+.06*g,O,4*l,0,2*Math.PI),e.fill(),e.fillStyle=L(V[n],.8),e.beginPath(),e.arc(q+.06*g,O,1.8*l,0,2*Math.PI),e.fill(),e.fillStyle="#0A0A12",e.beginPath(),e.rect(t-.1*g,y,.2*g,v-y+2),e.fill();let U=.36*g,K=x+U+.03*f,Z=e.createRadialGradient(t-.3*U,K-.2*U,.1*U,t,K,U);Z.addColorStop(0,"#14141E"),Z.addColorStop(.7,"#0A0A14"),Z.addColorStop(1,"#06060E"),e.fillStyle=Z,e.beginPath(),e.arc(t,K,U,0,2*Math.PI),e.fill();let $=H[n],J=function(e,t){let a=e.replace("#",""),n=Math.max(0,parseInt(a.substring(0,2),16)-60),r=Math.max(0,parseInt(a.substring(2,4),16)-60),l=Math.max(0,parseInt(a.substring(4,6),16)-t);return"rgb(".concat(n,",").concat(r,",").concat(l,")")}($,60),ee=e.createRadialGradient(t-.2*U,K-.5*U,.2*U,t,K-.2*U,1.15*U);ee.addColorStop(0,$),ee.addColorStop(.7,$),ee.addColorStop(1,J),e.fillStyle=ee,e.beginPath(),e.arc(t,K-.12*U,1.08*U,1.05*Math.PI,-.05*Math.PI),e.closePath(),e.fill(),e.fillStyle=J,e.beginPath(),e.moveTo(t-1.08*U,K-.12*U),e.quadraticCurveTo(t-1.12*U,K+.2*U,t-U,K+.55*U),e.quadraticCurveTo(t-.85*U,K+.7*U,t-.65*U,K+.65*U),e.lineTo(t-.88*U,K),e.closePath(),e.fill(),e.beginPath(),e.moveTo(t+1.08*U,K-.12*U),e.quadraticCurveTo(t+1.12*U,K+.2*U,t+ +U,K+.55*U),e.quadraticCurveTo(t+.85*U,K+.7*U,t+.65*U,K+.65*U),e.lineTo(t+.88*U,K),e.closePath(),e.fill(),e.fillStyle=$,e.beginPath(),e.moveTo(t-1.06*U,K-.1*U),e.quadraticCurveTo(t-1.08*U,K+.1*U,t-.98*U,K+.45*U),e.lineTo(t-.9*U,K+.1*U),e.closePath(),e.fill(),e.fillStyle=L("#FFFFFF",.2),e.beginPath(),e.ellipse(t-.15*U,K-.55*U,.5*U,.12*U,-.2,0,2*Math.PI),e.fill();let et=e.createRadialGradient(t,K-.3*U,0,t,K-.3*U,1.8*U);et.addColorStop(0,L($,.25)),et.addColorStop(1,L($,0)),e.fillStyle=et,e.beginPath(),e.arc(t,K-.3*U,1.8*U,0,2*Math.PI),e.fill();let ea=V[n],en=K+.08*U,er=.36*U,el=.2*U,eo=.16*U,ei=e.createRadialGradient(t,en,0,t,en,.9*U);ei.addColorStop(0,L(ea,.2)),ei.addColorStop(1,L(ea,0)),e.fillStyle=ei,e.beginPath(),e.arc(t,en,.9*U,0,2*Math.PI),e.fill();let es=e.createRadialGradient(t-er,en,.2*el,t-er,en,el);es.addColorStop(0,"#FFFFFF"),es.addColorStop(.3,ea),es.addColorStop(1,L(ea,.6)),e.fillStyle=es,e.beginPath(),e.ellipse(t-er,en,el,eo,0,0,2*Math.PI),e.fill(),e.strokeStyle=L(ea,.5),e.lineWidth=.6,e.beginPath(),e.ellipse(t-er,en,1.3*el,1.3*eo,0,0,2*Math.PI),e.stroke();let ec=e.createRadialGradient(t+er,en,.2*el,t+er,en,el);ec.addColorStop(0,"#FFFFFF"),ec.addColorStop(.3,ea),ec.addColorStop(1,L(ea,.6)),e.fillStyle=ec,e.beginPath(),e.ellipse(t+er,en,el,eo,0,0,2*Math.PI),e.fill(),e.strokeStyle=L(ea,.5),e.lineWidth=.6,e.beginPath(),e.ellipse(t+er,en,1.3*el,1.3*eo,0,0,2*Math.PI),e.stroke(),e.strokeStyle=L(ea,.35),e.lineWidth=.8,e.beginPath(),e.arc(t,en+.28*U,.22*U,.15*Math.PI,.85*Math.PI),e.stroke(),e.strokeStyle=L(ea,.15),e.lineWidth=.5,e.beginPath(),e.moveTo(t,en+.02*U),e.lineTo(t-.05*U,en+.15*U),e.stroke()}(e,s,c,t.agentType,h,f,t.walkPhase,m,g),Q(e,s,c,t.agentType,h,f),e.restore();t.isFrozen&&function(e,t,a,n){let r=u.baseWidth*n,l=u.baseHeight*n,o=r/2;e.save(),e.globalAlpha=.3,e.fillStyle="#A8CFF5",e.beginPath(),e.ellipse(t,a-.5*l,.6*o,.5*l,0,0,2*Math.PI),e.fill(),e.globalAlpha=1,e.strokeStyle=L("#A8CFF5",.6),e.lineWidth=1.5,e.setLineDash([3,3]),e.beginPath(),e.ellipse(t,a-.5*l,.7*o,.55*l,0,0,2*Math.PI),e.stroke(),e.setLineDash([]),e.restore()}(e,s,c,f),function(e,t,a,n,r){let l=a-u.baseHeight*r-10*r,o=Y(n),i=4*r,s=e.createRadialGradient(t,l,0,t,l,4*i);s.addColorStop(0,L(o,.35)),s.addColorStop(1,L(o,0)),e.fillStyle=s,e.beginPath(),e.arc(t,l,4*i,0,2*Math.PI),e.fill();let c=e.createRadialGradient(t-.3*i,l-.3*i,.1*i,t,l,i);c.addColorStop(0,"#FFFFFF"),c.addColorStop(.3,o),c.addColorStop(1,L(o,.7)),e.fillStyle=c,e.beginPath(),e.arc(t,l,i,0,2*Math.PI),e.fill()}(e,s,c,t.avgP,f),a&&function(e,t,a,n){let r=u.baseWidth*n,l=u.baseHeight*n,o=r/2;e.strokeStyle=L("#FFFFFF",.3),e.lineWidth=4,e.beginPath(),e.ellipse(t,a-.5*l,.7*o,.54*l,0,0,2*Math.PI),e.stroke(),e.strokeStyle=L("#FFFFFF",.8),e.lineWidth=1.5,e.beginPath(),e.ellipse(t,a-.5*l,.68*o,.52*l,0,0,2*Math.PI),e.stroke()}(e,s,c,f),e.restore()})(a,e,e.id===t)}}(e,t.hoveredAgent)),f&&f.active){let t=j(e.gridX,e.gridY),a=t.x+e.walkOffsetX,n=t.y+e.walkOffsetY;i.push({depth:e.gridX+e.gridY+.1,render:t=>(function(e,t,a,n,r,l){let o=Date.now()-r;if(o>l||o<0)return;let i=o/l,s=1-i,c=a-56*n-8*n;e.save(),e.font=T,e.textAlign="center";let d=3+Math.floor(3*Math.random()),h=Math.floor(o/40);for(let a=0;a<d;a++){let n=String.fromCharCode(65382+(31*h+17*a>>>0)%56%56),r=(a-(d-1)/2)*8,l=-(6*Math.sin(i*Math.PI));e.fillStyle=w(.8*s),e.fillText(n,t+r,c+l)}e.restore()})(t,a,n,e.scale,f.startTime,f.duration)})}let m=new Set(t.agents.map(e=>"".concat(e.gridX,",").concat(e.gridY)));for(let e of function(e,t){if(J===e&&$)return $;let a=Z(7919),n=[],r=["tower","spire","node"];for(let l=0;l<e;l++)for(let o=0;o<e;o++)!t.has("".concat(l,",").concat(o))&&(a()>.15||n.push({gridX:l,gridY:o,type:r[Math.floor(a()*r.length)],seed:Math.floor(1e4*a())}));return $=n,J=e,n}(t.gridSize,m))i.push(function(e,t,a){return{depth:e.gridX+e.gridY-.3,render:n=>(function(e,t,a,n){let r=j(t.gridX,t.gridY),l=r.x,o=r.y,i=n?Math.max(0,Math.min(1,(n.total_welfare+50)/100)):.5,s=a.threatLevel,d=s>.4?W(c.accent,c.alert,Math.min((s-.4)/.4,1)):c.accent,h=.4+.6*i;switch(e.save(),t.type){case"tower":!function(e,t,a,n,r,l,o){let i=20+100*n;G.drawBuilding(e,"tower",t,a,44.24,i)||(e.beginPath(),e.moveTo(t,a),e.lineTo(t+21.12,a-10.56),e.lineTo(t+21.12,a-10.56-i),e.lineTo(t,a-i),e.closePath(),e.fillStyle=L("#1A2233",.9*l),e.fill(),e.strokeStyle=L(r,.3*l),e.lineWidth=.5,e.stroke(),e.beginPath(),e.moveTo(t,a),e.lineTo(t-21.12,a-10.56),e.lineTo(t-21.12,a-10.56-i),e.lineTo(t,a-i),e.closePath(),e.fillStyle=L("#0F1620",.9*l),e.fill(),e.strokeStyle=L(r,.25*l),e.lineWidth=.5,e.stroke(),e.beginPath(),e.moveTo(t,a-i-10.56),e.lineTo(t+21.12,a-10.56-i),e.lineTo(t,a-i),e.lineTo(t-21.12,a-10.56-i),e.closePath(),e.fillStyle=L("#243040",.9*l),e.fill(),e.strokeStyle=L(r,.4*l),e.lineWidth=.5,e.stroke());let s=Z(o),c=Math.max(2,Math.floor(i/14));for(let n=0;n<c;n++)for(let o=0;o<2;o++){let c=a-6-12*n,d=t+3+8*o;!(c<a-i+4)&&s()>.3&&(e.fillStyle=L(r,l*(.4+.4*s())),e.fillRect(d,c,4,3))}for(let n=0;n<c;n++)for(let o=0;o<2;o++){let c=a-6-12*n,d=t-7-8*o;!(c<a-i+4)&&s()>.3&&(e.fillStyle=L(r,l*(.3+.3*s())),e.fillRect(d,c,4,3))}let d=8+12*n;e.beginPath(),e.moveTo(t,a-i-10.56),e.lineTo(t,a-i-10.56-d),e.strokeStyle=L(r,.6*l),e.lineWidth=1,e.stroke(),e.beginPath(),e.arc(t,a-i-10.56-d,1.5,0,2*Math.PI),e.fillStyle=L(r,.8*l),e.fill(),e.strokeStyle=L(r,.06*l),e.lineWidth=.5;for(let n=a-i;n<a;n+=3)e.beginPath(),e.moveTo(t-21.12,n),e.lineTo(t+21.12,n),e.stroke()}(e,l,o,i,d,h,t.seed);break;case"spire":!function(e,t,a,n,r,l,o){var i;let s=Math.min((null!=(i=null==n?void 0:n.avg_degree)?i:2)/8,1),c=30+90*s;G.drawBuilding(e,"spire",t,a,6,c)||(e.beginPath(),e.moveTo(t-3,a),e.lineTo(t+3,a),e.lineTo(t+1,a-c),e.lineTo(t-1,a-c),e.closePath(),e.fillStyle=L("#1A2233",.8*l),e.fill(),e.strokeStyle=L(r,.3*l),e.lineWidth=.5,e.stroke());let d=Date.now(),h=2+ +(s>.5);for(let n=0;n<h;n++){let o=(d/1200+.8*n)%1,i=a-.4*c-n*c*.2,h=6+10*o,u=3+5*o,f=(1-o)*l*.5*s;e.beginPath(),e.ellipse(t,i,h,u,0,0,2*Math.PI),e.strokeStyle=L(r,f),e.lineWidth=1,e.stroke()}e.beginPath(),e.arc(t,a-c,2,0,2*Math.PI),e.fillStyle=L(r,.7*l),e.fill()}(e,l,o,n,d,h,t.seed);break;case"node":!function(e,t,a,n,r,l,o){let i=1-n,s=12+18*i;G.drawBuilding(e,"node",t,a,36.56,s)||(e.beginPath(),e.moveTo(t,a),e.lineTo(t+17.28,a-8.64),e.lineTo(t+17.28,a-8.64-s),e.lineTo(t,a-s),e.closePath(),e.fillStyle=L("#1A2233",.85*l),e.fill(),e.beginPath(),e.moveTo(t,a),e.lineTo(t-17.28,a-8.64),e.lineTo(t-17.28,a-8.64-s),e.lineTo(t,a-s),e.closePath(),e.fillStyle=L("#0F1620",.85*l),e.fill(),e.beginPath(),e.moveTo(t,a-s-8.64),e.lineTo(t+17.28,a-8.64-s),e.lineTo(t,a-s),e.lineTo(t-17.28,a-8.64-s),e.closePath(),e.fillStyle=L("#243040",.85*l),e.fill(),e.strokeStyle=L(r,.3*l),e.lineWidth=.5,e.beginPath(),e.moveTo(t,a),e.lineTo(t+17.28,a-8.64),e.lineTo(t+17.28,a-8.64-s),e.lineTo(t,a-s),e.stroke(),e.beginPath(),e.moveTo(t,a),e.lineTo(t-17.28,a-8.64),e.lineTo(t-17.28,a-8.64-s),e.lineTo(t,a-s),e.stroke());let c=10+14*i,d=e.createRadialGradient(t,a-s-4.32,0,t,a-s-4.32,c);d.addColorStop(0,L(r,i*l*.5)),d.addColorStop(1,L(r,0)),e.fillStyle=d,e.beginPath(),e.arc(t,a-s-4.32,c,0,2*Math.PI),e.fill()}(e,l,o,s,d,h,t.seed)}e.restore()})(n,e,t,a)}}(e,t.environment,t.epoch));if(t.epoch&&i.push({depth:t.gridSize-2+1-.2,render:e=>(function(e,t,a){if(!a||0===a.total_posts+a.total_votes+a.total_tasks_completed)return;let n=j(t-2,1),r=n.x,l=n.y,o=Math.max(1,a.total_posts,a.total_votes,a.total_tasks_completed);for(let t of(e.save(),ee)){let n=t.getValue(a);if(0===n)continue;let i=r+t.offsetX,s=Math.min(n/o,1),c=8+50*s,d=.5+.3*s;e.beginPath(),e.moveTo(i,l),e.lineTo(i+5.76,l-2.88),e.lineTo(i+5.76,l-2.88-c),e.lineTo(i,l-c),e.closePath(),e.fillStyle=L(t.color,.5*d),e.fill(),e.beginPath(),e.moveTo(i,l),e.lineTo(i-5.76,l-2.88),e.lineTo(i-5.76,l-2.88-c),e.lineTo(i,l-c),e.closePath(),e.fillStyle=L(t.color,.35*d),e.fill(),e.beginPath(),e.moveTo(i,l-c-2.88),e.lineTo(i+5.76,l-2.88-c),e.lineTo(i,l-c),e.lineTo(i-5.76,l-2.88-c),e.closePath(),e.fillStyle=L(t.color,.6*d),e.fill(),e.strokeStyle=L(t.color,.4*d),e.lineWidth=.5,e.beginPath(),e.moveTo(i,l),e.lineTo(i+5.76,l-2.88),e.lineTo(i+5.76,l-2.88-c),e.lineTo(i,l-c),e.lineTo(i-5.76,l-2.88-c),e.lineTo(i-5.76,l-2.88),e.closePath(),e.stroke(),e.strokeStyle=L(t.color,.06),e.lineWidth=.4;for(let t=l-c;t<l;t+=4)e.beginPath(),e.moveTo(i-5.76,t),e.lineTo(i+5.76,t),e.stroke();e.font="bold 7px 'Courier New', monospace",e.textAlign="center",e.fillStyle=L(t.color,.8),e.fillText(String(n),i,l-c-2.88-4)}e.restore()})(e,t.gridSize,t.epoch)}),t.overlays.interactions)for(let e of t.arcs){let a=function(e,t,a){let n=t.get(e.fromId),r=t.get(e.toId);if(!n||!r)return null;let l=a===e.fromId||a===e.toId;return{depth:Math.max(n.gridX+n.gridY,r.gridX+r.gridY)+.5,render:t=>(function(e,t,a,n,r){let l=j(a.gridX,a.gridY),i=j(n.gridX,n.gridY),c={x:l.x+a.walkOffsetX,y:l.y+a.walkOffsetY},d=c.y-a.scale*u.baseHeight*.6,h=i.y-n.scale*u.baseHeight*.6,f=Y(t.p),p=1-Math.pow(1-t.progress,3),m=(c.x+i.x)/2,x=Math.min(d,h)-40-.15*Math.abs(c.x-i.x);e.save();let y=function(e){switch(e){case"communication":return{dash:[2,4],widthBonus:0,double:!1};case"task":return{dash:[],widthBonus:.5,double:!1};case"governance":return{dash:[],widthBonus:0,double:!0};default:return{dash:[],widthBonus:0,double:!1}}}(t.interactionType);if(t.accepted){if(e.strokeStyle=L(f,r?.15:.08),e.lineWidth=1+y.widthBonus,y.dash.length>0&&e.setLineDash(y.dash),e.beginPath(),e.moveTo(c.x,d),e.quadraticCurveTo(m,x,i.x,h),e.stroke(),y.double&&(e.beginPath(),e.moveTo(c.x,d-2),e.quadraticCurveTo(m,x-2,i.x,h-2),e.stroke()),y.dash.length>0&&e.setLineDash([]),p>.01){e.strokeStyle=L(f,r?.5:.25),e.lineWidth=(r?2:1)+y.widthBonus,y.dash.length>0&&e.setLineDash(y.dash),e.beginPath(),e.moveTo(c.x,d);let t=Math.max(8,Math.floor(30*p));for(let a=1;a<=t;a++){let n=a/t*p,r=U(c.x,d,m,x,i.x,h,n);e.lineTo(r.x,r.y)}if(e.stroke(),y.double){e.beginPath(),e.moveTo(c.x,d-2);let t=Math.max(8,Math.floor(30*p));for(let a=1;a<=t;a++){let n=a/t*p,r=U(c.x,d-2,m,x-2,i.x,h-2,n);e.lineTo(r.x,r.y)}e.stroke()}y.dash.length>0&&e.setLineDash([])}if(p<1&&function(e,t,a,n,r,l,o,i,c,d,h){var u,f,p,m;let x=s(t.id),y=Date.now(),v=Math.max(0,Math.min(1,t.p)),S=Math.round((u=g.charCountMin,u+(g.charCountMax-u)*v)),M=(f=g.charSpacingMax,f+(g.charSpacingMin-f)*v),w=(p=g.mutateIntervalMax,p+(g.mutateIntervalMin-p)*v),k=(m=g.glowRadiusMin,m+(g.glowRadiusMax-m)*v);e.save(),e.font=T,e.textAlign="center";for(let s=0;s<S;s++){let u=c-s*M;if(u<0||u>1)continue;let f=U(a,n,r,l,o,i,u),p=b(x+31*s+Math.floor(y/w)),g=(1-s/S)*(h?.9:.7);if(0===s){e.fillStyle="rgba(255,255,255,".concat(g,")"),e.fillText(p,f.x,f.y);let t=e.createRadialGradient(f.x,f.y,0,f.x,f.y,k);t.addColorStop(0,L(d,.4)),t.addColorStop(1,L(d,0)),e.fillStyle=t,e.beginPath(),e.arc(f.x,f.y,k,0,2*Math.PI),e.fill()}else e.fillStyle=P(t.p,g),e.fillText(p,f.x,f.y)}e.restore()}(e,t,c.x,d,m,x,i.x,h,p,f,r),p>=.45&&p<=.55&&function(e,t,a,n,r,l,o,i,c,d){let h=s(t.id),u=Date.now(),f=(a+r)/2,p=(n+l)/2-15,m=.7*Math.sin((c-.45)/.1*Math.PI);e.save(),e.font=T,e.textAlign="center";let{gridSize:x,gridSpacing:y}=g,v=Math.floor(u/60);for(let a=0;a<x;a++)for(let n=0;n<x;n++){let r=f+(n-1)*y,l=p+(a-1)*y,o=b(h+7*a+13*n+v);e.fillStyle=P(t.p,m*(.5+.5*Math.random())),e.fillText(o,r,l)}e.restore()}(e,t,c.x,d,i.x,h,0,0,p,0),p>.95){let t=(1-(p-.95)/.05)*.6,a=6+(p-.95)/.05*12,n=e.createRadialGradient(i.x,h,0,i.x,h,a);n.addColorStop(0,L(f,t)),n.addColorStop(1,L(f,0)),e.fillStyle=n,e.beginPath(),e.arc(i.x,h,a,0,2*Math.PI),e.fill()}}else{if(e.strokeStyle=L(f,(r?.7:.3)*(1-.5*p)),e.lineWidth=r?2:1,e.setLineDash([4,4]),e.beginPath(),e.moveTo(c.x,d),e.quadraticCurveTo(m,x,i.x,h),e.stroke(),function(e,t,a,n,r,l,o,i,c,d){if(c<.15||c>.9)return;let h=s(t.id),u=Date.now();e.save(),e.font=T,e.textAlign="center";for(let t=0;t<6;t++){let s=.8*c-.06*t;if(s<0||s>1)continue;let f=U(a,n,r,l,o,i,s),p=h+17*t+Math.floor(u/100),g=M(p),m=(c-.15)*15,x=f.x+Math.sin(p)*m,y=f.y+Math.cos(1.3*p)*m,v=(1-t/6)*(d?.7:.4)*(1-c);e.fillStyle="rgba(235,87,87,".concat(v,")"),e.fillText(g,x,y)}e.restore()}(e,t,c.x,d,m,x,i.x,h,p,r),p>.2&&p<.85){let t=U(c.x,d,m,x,i.x,h,.5);e.strokeStyle=L("#EB5757",.8*(p<.5?o((p-.2)/.3):1-o((p-.5)/.35))),e.lineWidth=2,e.setLineDash([]),e.beginPath(),e.moveTo(t.x-5,t.y-5),e.lineTo(t.x+5,t.y+5),e.moveTo(t.x+5,t.y-5),e.lineTo(t.x-5,t.y+5),e.stroke()}if(p>.3&&p<.8){let a=U(c.x,d,m,x,i.x,h,.5),n=1-(p-.3)/.5,r=s(t.id);e.font=T,e.textAlign="center";for(let t=0;t<6;t++){let l=t/6*Math.PI*2+3*p,o=(p-.3)*35,i=M(r+13*t+Math.floor(5*p));e.fillStyle=L("#EB5757",.7*n),e.fillText(i,a.x+Math.cos(l)*o,a.y+Math.sin(l)*o)}}}e.restore()})(t,e,n,r,l)}}(e,h,t.hoveredAgent);a&&i.push(a)}for(let t of i.slice().sort((e,t)=>e.depth-t.depth))t.render(e);if(t.overlays.collusionLines&&t.environment.collusionRisk>.1){let a=new Set(["adversarial","deceptive","opportunistic"]),n=t.agents.filter(e=>a.has(e.agentType));for(let a=0;a<n.length;a++)for(let r=a+1;r<n.length;r++)!function(e,t,a,n){let r=j(t.gridX,t.gridY),l=j(a.gridX,a.gridY),o=r.y-t.scale*u.baseHeight*.3,i=l.y-a.scale*u.baseHeight*.3;e.save();let s=Date.now()/1e3;for(let t=0;t<2;t++){let a=0===t?1:-1;e.strokeStyle=L("#5B2D8B",n*(.3+.15*t)),e.lineWidth=1.5-.5*t,e.beginPath();for(let c=0;c<=20;c++){let d=c/20,h=r.x+(l.x-r.x)*d,u=o+(i-o)*d,f=6*Math.sin(d*Math.PI*4+2.5*s+t)*a*n,p=h+.3*f,g=u+f;0===c?e.moveTo(p,g):e.lineTo(p,g)}e.stroke()}for(let t=0;t<3;t++){let a=(.8*s+.33*t)%1,c=r.x+(l.x-r.x)*a,d=o+(i-o)*a;e.fillStyle=L("#BB6BD9",Math.sin(a*Math.PI)*n*.6),e.beginPath(),e.arc(c,d,2.5,0,2*Math.PI),e.fill()}e.restore()}(e,n[a],n[r],t.environment.collusionRisk)}if(t.environment.avgSynergyScore>.1){let a=new Set(["cooperative","altruistic"]),n=t.agents.filter(e=>a.has(e.agentType));for(let a=0;a<n.length;a++)for(let r=a+1;r<n.length;r++)!function(e,t,a,n){let r=j(t.gridX,t.gridY),l=j(a.gridX,a.gridY),o=r.y-t.scale*u.baseHeight*.3,i=l.y-a.scale*u.baseHeight*.3;e.save();let s=Date.now()/1e3,c=(r.x+l.x)/2,d=(o+i)/2-20;e.strokeStyle=L("#F2C94C",.3*n),e.lineWidth=1.5,e.beginPath(),e.moveTo(r.x,o),e.quadraticCurveTo(c,d,l.x,i),e.stroke();for(let t=0;t<4;t++){let a=(.5*s+.25*t)%1,h=1-a,u=h*h*r.x+2*h*a*c+a*a*l.x,f=h*h*o+2*h*a*d+a*a*i;e.fillStyle=L("#F2C94C",Math.sin(a*Math.PI)*n*.5),e.beginPath(),e.arc(u,f,2,0,2*Math.PI),e.fill()}e.restore()}(e,n[a],n[r],t.environment.avgSynergyScore)}if(t.overlays.particles&&function(e,t){for(let a of t){let t=a.life/a.maxLife;e.fillStyle=L(a.color,a.alpha*t),e.beginPath(),e.arc(a.x,a.y,a.size*t,0,2*Math.PI),e.fill()}}(e,t.particles),e.restore(),!function(e,t,a,n){if(n<.05)return;let r=Math.min(n,1),l=n>.5?"#EB5757":"#6FCF97",o=Date.now()/1e3,i=e.createLinearGradient(0,.55*a,0,a);i.addColorStop(0,L(l,0)),i.addColorStop(.5,L(l,.08*r)),i.addColorStop(1,L(l,.18*r)),e.fillStyle=i,e.fillRect(0,0,t,a);for(let n=0;n<2;n++){let i=a*(.7+.12*n),s=r*(.06-.02*n);e.beginPath(),e.moveTo(0,a);for(let a=0;a<=t;a+=8){let t=i+8*Math.sin(.01*a+o*(.5+.3*n));e.lineTo(a,t)}e.lineTo(t,a),e.closePath(),e.fillStyle=L(l,s),e.fill()}}(e,a,n,t.environment.toxicity),t.overlays.tierraStrip&&function(e,t,a,n,r){if(0===t.length)return;let l=r-18-4-56,o=t.reduce((e,t)=>e+Math.max(t.resources,1),0);if(o<=0)return;e.save(),e.fillStyle=L("#000000",.6),e.fillRect(0,l-1,n,20);let i=0;for(let r of t){let t=Math.max(r.resources,1)/o*n,s=d[r.agentType],c=0!==r.walkOffsetX||0!==r.walkOffsetY;if(e.fillStyle=r.id===a?"#FFFFFF":s.secondary,e.fillRect(i,l,t,18),c){let a=.5+.5*Math.sin(Date.now()/200);e.strokeStyle=L(s.accent,.6+.4*a),e.lineWidth=2,e.strokeRect(i+1,l+1,t-2,16)}e.fillStyle=L("#000000",.5),e.fillRect(i+t-.5,l,1,18),i+=t}e.fillStyle=L("#000000",.15);for(let t=l;t<l+18;t+=2)e.fillRect(0,t,n,1);e.fillStyle=L("#00FF41",.2),e.fillRect(0,l-1,n,1),e.fillRect(0,l+18,n,1),e.restore()}(e,t.agents,t.hoveredAgent,a,n),t.recompileState&&t.recompileState.active&&function(e,t,a,n){if(!t.active)return;let r=Date.now()-t.startTime;if(r>t.duration)return;let l=r/t.duration;if(l<.5){let t=l/.5*n,r=e.createLinearGradient(0,t-30,0,t+30);r.addColorStop(0,w(0)),r.addColorStop(.4,w(.3)),r.addColorStop(.5,w(.6)),r.addColorStop(.6,w(.3)),r.addColorStop(1,w(0)),e.fillStyle=r,e.fillRect(0,t-30,a,60)}l>.3&&(e.fillStyle=w(Math.max(0,(1-(l-.3)/.7)*.08)),e.fillRect(0,0,a,n))}(e,t.recompileState,a,n),t.environment.incoherence>.15&&function(e,t,a,n){let r;if(n<.15)return;let l=Math.min((n-.15)/.6,1),o=Date.now(),i=(r=0|Math.floor(o/80),()=>{let e=Math.imul((r=r+0x6d2b79f5|0)^r>>>15,1|r);return(((e=e+Math.imul(e^e>>>7,61|e)^e)^e>>>14)>>>0)/0x100000000}),s=Math.floor(1+5*l);e.save();for(let n=0;n<s;n++){if(i()>.3+.5*l)continue;let n=Math.floor(i()*a),r=2+Math.floor(i()*(4+12*l)),o=(i()-.5)*(3+12*l);try{let l=e.getImageData(0,n,t,Math.min(r,a-n));e.putImageData(l,o,n)}catch(e){break}}if(l>.4){let n=(l-.4)*.08,r=Math.floor(o/120);e.fillStyle=L("#00FFFF",n);for(let n=0;n<3;n++){let l=(37*r+131*n)%a;e.fillRect(0,l,t,1)}e.fillStyle=L(c.alert,n);for(let n=0;n<2;n++){let l=(53*r+97*n)%a;e.fillRect(0,l,t,1)}}e.restore()}(e,a,n,t.environment.incoherence),t.hoveredAgent){let a=t.agents.find(e=>e.id===t.hoveredAgent);a&&function(e,t,a){let n=j(a.gridX,a.gridY),r=(n.x+a.walkOffsetX)*t.zoom+t.x,l=(n.y+a.walkOffsetY-56*a.scale-30)*t.zoom+t.y,o="".concat(a.name," (").concat(a.agentType,")"),i="Rep: ".concat(a.reputation.toFixed(2)," | P: ").concat(a.avgP.toFixed(2)),s=a.isFrozen?"FROZEN":a.isQuarantined?"QUARANTINED":"";e.save(),e.font="bold 12px -apple-system, sans-serif";let d=Math.max(e.measureText(o).width,e.measureText(i).width,s?e.measureText(s).width:0)+20,h=s?48:38,u=r-d/2,f=l-h-8;e.shadowColor="rgba(0,0,0,0.4)",e.shadowBlur=8,e.shadowOffsetY=2,e.fillStyle=c.panel,e.strokeStyle=c.border,e.lineWidth=1,e.beginPath(),e.roundRect(u,f,d,h,6),e.fill(),e.shadowColor="transparent",e.stroke(),e.fillStyle=c.panel,e.beginPath(),e.moveTo(r-5,f+h),e.lineTo(r,f+h+5),e.lineTo(r+5,f+h),e.closePath(),e.fill(),e.fillStyle=c.text,e.textAlign="center",e.fillText(o,r,f+15),e.font="11px -apple-system, sans-serif",e.fillStyle=c.muted,e.fillText(i,r,f+29),s&&(e.font="bold 10px -apple-system, sans-serif",e.fillStyle=a.isFrozen?"#A8CFF5":"#EB5757",e.fillText(s,r,f+42)),e.restore()}(e,t.viewport,a)}}(r,{agents:t,arcs:a,viewport:i,hoveredAgent:h,selectedAgent:f,epoch:m,environment:x,overlays:y,particles:v,gridSize:S,digitalRain:I.current,codeTrails:C.current.particles,recompileState:E.current}),r.restore())});let O=(0,r.useCallback)((e,a)=>{let n={x:(e-i.x)/i.zoom,y:(a-i.y)/i.zoom};for(let e of[...t].sort((e,t)=>t.gridX+t.gridY-(e.gridX+e.gridY))){let t=function(e){let{x:t,y:a}=j(e.gridX,e.gridY),n=t+e.walkOffsetX,r=a+e.walkOffsetY,l=u.baseWidth*e.scale;return{minX:n-l/2,minY:r-u.baseHeight*e.scale-10,maxX:n+l/2,maxY:r}}(e);if(n.x>=t.minX&&n.x<=t.maxX&&n.y>=t.minY&&n.y<=t.maxY)return e.id}return null},[t,i]),et=(0,r.useCallback)(e=>{X.current=!0,q.current={x:e.clientX,y:e.clientY}},[]),ea=(0,r.useCallback)(t=>{var a;let n=null==(a=e.current)?void 0:a.getBoundingClientRect();if(!n)return;let r=t.clientX-n.left,l=t.clientY-n.top;X.current?(R(t.clientX-q.current.x,t.clientY-q.current.y),q.current={x:t.clientX,y:t.clientY}):k(O(r,l))},[R,O,k]),en=(0,r.useCallback)(t=>{let a=X.current;if(X.current=!1,!a||3>Math.abs(t.clientX-q.current.x)&&3>Math.abs(t.clientY-q.current.y)){var n;let a=null==(n=e.current)?void 0:n.getBoundingClientRect();if(!a)return;_(O(t.clientX-a.left,t.clientY-a.top))}},[O,_]),er=(0,r.useCallback)(t=>{var a;t.preventDefault();let n=null==(a=e.current)?void 0:a.getBoundingClientRect();n&&A(t.deltaY,t.clientX-n.left,t.clientY-n.top)},[A]),el=(0,r.useCallback)(()=>{B()},[B]);return(0,n.jsx)("canvas",{ref:e,className:"absolute inset-0 cursor-grab active:cursor-grabbing",onMouseDown:et,onMouseMove:ea,onMouseUp:en,onMouseLeave:()=>{X.current=!1,k(null)},onWheel:er,onDoubleClick:el})}let ea=[.5,1,2,4];function en(){let{play:e,pause:t,setEpoch:a,setSpeed:o,playing:c,speed:d,currentEpoch:h,maxEpoch:u}=function(){let{state:e,dispatch:t,interactionSystem:a,particleSystem:n,codeTrailSystem:o,digitalRainRef:c,recompileStateRef:d,agentPositions:h,agentsByEpoch:u}=(0,r.useContext)(R),g=(0,r.useRef)(0),m=(0,r.useRef)(0),x=(0,r.useRef)(0),y=(0,r.useRef)(0),b=(0,r.useRef)(0),S=(0,r.useRef)(-1),M=(0,r.useRef)(new Map),w=(0,r.useRef)(new Map),P=(0,r.useRef)(()=>{}),T=(0,r.useCallback)(r=>{var T,k,_,C;if(!e.data)return;let F=m.current?r-m.current:16;m.current=r;let I=e.currentEpoch,E=e.epochFraction;if(e.playing&&(x.current+=F*e.speed,(E=x.current/f.epochTransition)>=1)){E=0,x.current=0,I=Math.min(I+1,e.data.epoch_snapshots.length-1);let n=e.data.epoch_snapshots[I];if(n){let t=e.data.events;if(t&&t.length>0)a.current.addFromEvents(t,I);else{let e=[...h.current.keys()],t=n.total_interactions>0?n.accepted_interactions/n.total_interactions:.5;a.current.addSyntheticArcs(e,I,n.total_interactions,n.avg_p,t)}}I>=e.data.epoch_snapshots.length-1&&t({type:"SET_PLAYING",playing:!1})}S.current>=0&&I!==S.current&&(d.current={active:!0,startTime:Date.now(),duration:400,scanlineY:0}),S.current=I;let R=d.current;if(R.active&&Date.now()-R.startTime>R.duration&&(R.active=!1),a.current.update(F,I),n.current.update(F),o.current.update(F),!c.current&&e.viewport.width>0&&(c.current=function(e){let t=Math.ceil(e/18),a=[];for(let e=0;e<t;e++){let t=8+Math.floor(14*Math.random()),n=[];for(let e=0;e<t;e++)n.push(v());let r=(Math.random()-.5)*6;a.push({x:18*e+9+r,speed:.02+.1*Math.random(),chars:n,headY:-500*Math.random(),charInterval:18+(Math.random()-.5)*4,brightness:.6+.4*Math.random(),nextMutateTime:50+150*Math.random()})}return{columns:a,initialized:!0}}(e.viewport.width)),c.current){let t=e.environment.threatLevel;!function(e,t,a,n){for(let r of e.columns){let e=1+.6*n;r.headY+=r.speed*t*e;let l=r.chars.length*r.charInterval;if(r.headY-l>a&&(r.headY=-200*Math.random()-50,r.speed=.02+.1*Math.random(),.3>Math.random())){let e=8+Math.floor(14*Math.random());for(;r.chars.length<e;)r.chars.push(v());r.chars.length>e&&(r.chars.length=e)}if(r.nextMutateTime-=t,r.nextMutateTime<=0){let e=Math.floor(Math.random()*r.chars.length);r.chars[e]=v(),r.nextMutateTime=50+150*Math.random()}}}(c.current,F,e.viewport.height,t)}let A=null!=(T=u.current.get(I))?T:new Map,N=Math.min(I+1,e.data.epoch_snapshots.length-1),D=null!=(k=u.current.get(N))?k:A,B=function(e,t,a,n){let r=[],o=new Set([...e.keys(),...t.keys()]),s=i(0,1,a);for(let i of o){var c,d,h,u,f,p,g,m;let o=e.get(i),x=t.get(i),y=n.get(i);if(!y)continue;let v=null!=o?o:x,b=null!=x?x:o,S=(h=v.reputation,h+(b.reputation-h)*s),M=(u=v.resources,u+(b.resources-u)*s),w=(f=v.total_payoff,f+(b.total_payoff-f)*s),P=(p=(v.avg_p_initiated+v.avg_p_received)/2||.5,p+(((b.avg_p_initiated+b.avg_p_received)/2||.5)-p)*s),T=a<.5?v.is_frozen:b.is_frozen,k=a<.5?v.is_quarantined:b.is_quarantined,_=l(.6+(S+1)*.4,.6,1.4);r.push({id:i,name:null!=(c=b.name)?c:i.slice(0,8),agentType:null!=(d=b.agent_type)?d:"honest",reputation:S,resources:M,totalPayoff:w,avgP:P,isFrozen:T,isQuarantined:k,scale:_,gridX:y.gridX,gridY:y.gridY,interactionsInitiated:Math.round((g=v.interactions_initiated,g+(b.interactions_initiated-g)*s)),interactionsReceived:Math.round((m=v.interactions_received,m+(b.interactions_received-m)*s)),walkOffsetX:0,walkOffsetY:0,walkPhase:0,facing:1})}return r}(A,D,E,h.current),W=new Map(B.map(e=>[e.id,e])),L=new Set;for(let e of a.current.arcs){let t;if(e.progress>=1)continue;let a=W.get(e.fromId),n=W.get(e.toId);if(!a||!n||L.has(e.fromId))continue;let r=j(a.gridX,a.gridY),l=j(n.gridX,n.gridY),o=p[a.agentType],c=e.progress;t=c<.45?i(0,.45,c):c<.55?1:1-i(.55,1,c);let d=(l.x-r.x)*t*.85,h=(l.y-r.y)*t*.85,u=Math.sqrt((l.x-r.x)**2+(l.y-r.y)**2),f=u>0?-(l.y-r.y)/u:0,g=u>0?(l.x-r.x)/u:0,m=o.swayAmplitude*Math.sin(3.5*a.walkPhase)*4,x=Math.sin(t*Math.PI)*((s(a.id)%200-100)/100*.15)*u;a.walkOffsetX=d+f*m+f*x,a.walkOffsetY=h+g*m+g*x;let y=l.x-r.x;Math.abs(y)>1&&w.current.set(e.fromId,y>0?1:-1),L.add(e.fromId)}for(let e of L){let t=W.get(e),a=p[t.agentType],n=(null!=(_=M.current.get(e))?_:0)+F*a.walkRate;M.current.set(e,n),t.walkPhase=n}for(let e of B)e.facing=null!=(C=w.current.get(e.id))?C:1;for(let[e]of M.current)L.has(e)||M.current.delete(e);let Y=40+15*Math.sin(.003*r);if(r-b.current>Y)for(let e of(b.current=r,L)){let t=W.get(e),a=j(t.gridX,t.gridY),n=a.x+t.walkOffsetX,r=a.y+t.walkOffsetY;o.current.spawnBurst(n,r-28*t.scale,t.avgP,2)}if(r-y.current>500)for(let e of(y.current=r,B)){let t=j(e.gridX,e.gridY),a=t.x+e.walkOffsetX,r=t.y+e.walkOffsetY;e.isFrozen&&n.current.add(function(e,t,a){let n=[];for(let a=0;a<2;a++){let a=.2*Math.sin(Date.now()/2e3);n.push({x:e+(Math.random()-.5)*30,y:t-40*Math.random(),vx:(Math.random()-.5)*.3+a,vy:.5*Math.random()+.2,life:1e3+500*Math.random(),maxLife:1500,size:2+2*Math.random(),color:"#A8CFF5",alpha:.7})}return n}(a,r-56*e.scale,0)),e.isQuarantined&&n.current.add(function(e,t,a){let n=[];for(let a=0;a<2;a++){let a=Math.random()*Math.PI*2,r=20+15*Math.random();n.push({x:e+Math.cos(a)*r,y:t+Math.sin(a)*r*.5,vx:.2*Math.cos(a),vy:-(.5*Math.random())-.3,life:800+400*Math.random(),maxLife:1200,size:1.5+Math.random(),color:"#EB5757",alpha:.5})}return n}(a,r,0))}let z=e.data.epoch_snapshots[I],X=e.data.epoch_snapshots[N],q=function(e,t,a){var n,r,l,o,s,c,d,h,u,f,p,g,m,x,y,v,b,S,M,w,P,T,k,_,C,j,F,I,E,R,A,N,D,B,W;if(!e&&!t)return{threatLevel:0,toxicity:0,giniCoefficient:0,collusionRisk:0,incoherence:0,contagionDepth:0,activeThreats:0,reputationStd:0,payoffStd:0,avgSynergyScore:0,avgCoordinationScore:0,avgDegree:0,avgClustering:0};let L=null!=e?e:t,Y=null!=t?t:e,z=i(0,1,a);return{threatLevel:(k=null!=(n=L.ecosystem_threat_level)?n:0,k+((null!=(r=Y.ecosystem_threat_level)?r:0)-k)*z),toxicity:(_=L.toxicity_rate,_+(Y.toxicity_rate-_)*z),giniCoefficient:(C=L.gini_coefficient,C+(Y.gini_coefficient-C)*z),collusionRisk:(j=null!=(l=L.ecosystem_collusion_risk)?l:0,j+((null!=(o=Y.ecosystem_collusion_risk)?o:0)-j)*z),incoherence:(F=null!=(s=L.incoherence_index)?s:0,F+((null!=(c=Y.incoherence_index)?c:0)-F)*z),contagionDepth:(I=null!=(d=L.contagion_depth)?d:0,I+((null!=(h=Y.contagion_depth)?h:0)-I)*z),activeThreats:(E=null!=(u=L.active_threats)?u:0,E+((null!=(f=Y.active_threats)?f:0)-E)*z),reputationStd:(R=null!=(p=L.reputation_std)?p:0,R+((null!=(g=Y.reputation_std)?g:0)-R)*z),payoffStd:(A=null!=(m=L.payoff_std)?m:0,A+((null!=(x=Y.payoff_std)?x:0)-A)*z),avgSynergyScore:(N=null!=(y=L.avg_synergy_score)?y:0,N+((null!=(v=Y.avg_synergy_score)?v:0)-N)*z),avgCoordinationScore:(D=null!=(b=L.avg_coordination_score)?b:0,D+((null!=(S=Y.avg_coordination_score)?S:0)-D)*z),avgDegree:(B=null!=(M=L.avg_degree)?M:0,B+((null!=(w=Y.avg_degree)?w:0)-B)*z),avgClustering:(W=null!=(P=L.avg_clustering)?P:0,W+((null!=(T=Y.avg_clustering)?T:0)-W)*z)}}(z,X,E),O=z&&X?function(e,t,a){var n,r,l,o,s,c,d,h,u,f,p,g,m,x,y,v,b,S,M,w;let P=i(0,1,a);return{...t,epoch:e.epoch,total_interactions:Math.round((s=e.total_interactions,s+(t.total_interactions-s)*P)),accepted_interactions:Math.round((c=e.accepted_interactions,c+(t.accepted_interactions-c)*P)),rejected_interactions:Math.round((d=e.rejected_interactions,d+(t.rejected_interactions-d)*P)),toxicity_rate:(h=e.toxicity_rate,h+(t.toxicity_rate-h)*P),quality_gap:(u=e.quality_gap,u+(t.quality_gap-u)*P),avg_p:(f=e.avg_p,f+(t.avg_p-f)*P),total_welfare:(p=e.total_welfare,p+(t.total_welfare-p)*P),avg_payoff:(g=e.avg_payoff,g+(t.avg_payoff-g)*P),payoff_std:(m=e.payoff_std,m+(t.payoff_std-m)*P),gini_coefficient:(x=e.gini_coefficient,x+(t.gini_coefficient-x)*P),n_frozen:Math.round((y=e.n_frozen,y+(t.n_frozen-y)*P)),n_quarantined:Math.round((v=e.n_quarantined,v+(t.n_quarantined-v)*P)),avg_reputation:(b=e.avg_reputation,b+(t.avg_reputation-b)*P),reputation_std:(S=e.reputation_std,S+(t.reputation_std-S)*P),ecosystem_threat_level:(M=null!=(n=e.ecosystem_threat_level)?n:0,M+((null!=(r=t.ecosystem_threat_level)?r:0)-M)*P),ecosystem_collusion_risk:(w=null!=(l=e.ecosystem_collusion_risk)?l:0,w+((null!=(o=t.ecosystem_collusion_risk)?o:0)-w)*P)}}(z,X,E):null!=z?z:null;t({type:"TICK",agents:B,arcs:a.current.arcs,environment:q,particles:n.current.particles,epoch:I,fraction:E,epochSnap:O}),g.current=requestAnimationFrame(e=>P.current(e))},[e.data,e.playing,e.speed,e.currentEpoch,e.epochFraction,t,a,n,o,c,d,e.environment.threatLevel,e.viewport.height,e.viewport.width,h,u]);(0,r.useEffect)(()=>{P.current=T},[T]);let k=(0,r.useCallback)(()=>{t({type:"SET_PLAYING",playing:!0})},[t]),_=(0,r.useCallback)(()=>{t({type:"SET_PLAYING",playing:!1})},[t]),C=(0,r.useCallback)(n=>{if(x.current=0,t({type:"SET_EPOCH",epoch:n}),e.data){a.current.clear();let t=e.data.epoch_snapshots[n];if(t){let r=e.data.events;if(r&&r.length>0)a.current.addFromEvents(r,n);else{let e=[...h.current.keys()],r=t.total_interactions>0?t.accepted_interactions/t.total_interactions:.5;a.current.addSyntheticArcs(e,n,t.total_interactions,t.avg_p,r)}}}},[t,e.data,a,h]),F=(0,r.useCallback)(e=>t({type:"SET_SPEED",speed:e}),[t]);return(0,r.useEffect)(()=>(e.data&&(g.current=requestAnimationFrame(T)),()=>{g.current&&cancelAnimationFrame(g.current)}),[T,e.data]),{play:k,pause:_,setEpoch:C,setSpeed:F,playing:e.playing,speed:e.speed,currentEpoch:e.currentEpoch,maxEpoch:e.data?e.data.epoch_snapshots.length-1:0}}();return(0,n.jsxs)("div",{className:"absolute bottom-0 left-0 right-0 h-14 bg-panel border-t border-border flex items-center gap-3 px-4 z-[10000]",children:[(0,n.jsx)("button",{onClick:()=>c?t():e(),className:"w-9 h-9 flex items-center justify-center rounded bg-btn hover:bg-btn-hover transition-colors",title:c?"Pause":"Play",children:c?(0,n.jsxs)("svg",{width:"14",height:"14",viewBox:"0 0 14 14",fill:"currentColor",children:[(0,n.jsx)("rect",{x:"2",y:"1",width:"4",height:"12",rx:"1"}),(0,n.jsx)("rect",{x:"8",y:"1",width:"4",height:"12",rx:"1"})]}):(0,n.jsx)("svg",{width:"14",height:"14",viewBox:"0 0 14 14",fill:"currentColor",children:(0,n.jsx)("path",{d:"M3 1.5v11l9-5.5z"})})}),(0,n.jsxs)("span",{className:"text-xs text-muted w-20 text-center font-mono",children:["Epoch ",h,"/",u]}),(0,n.jsx)("input",{type:"range",min:0,max:u,value:h,onChange:e=>a(Number(e.target.value)),className:"flex-1 h-1.5 appearance-none bg-border rounded-full cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3.5 [&::-webkit-slider-thumb]:h-3.5 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-accent [&::-webkit-slider-thumb]:cursor-pointer"}),(0,n.jsxs)("div",{className:"flex items-center gap-1",children:[(0,n.jsx)("span",{className:"text-xs text-muted mr-1",children:"Speed"}),ea.map(e=>(0,n.jsxs)("button",{onClick:()=>o(e),className:"px-2 py-1 text-xs rounded transition-colors ".concat(d===e?"bg-accent text-bg font-bold":"bg-btn hover:bg-btn-hover text-muted"),children:[e,"x"]},e))]})]})}function er(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return Math.abs(e)>=1e3?e.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,","):e.toFixed(t)}function el(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return(100*e).toFixed(t)+"%"}function eo(){let{selectedAgent:e,agents:t,setSelected:a,agentSnapshots:l,currentEpoch:o}=N(),i=t.find(t=>t.id===e),s=(0,r.useMemo)(()=>(null==l?void 0:l.length)&&i?l.filter(e=>e.agent_id===i.id).sort((e,t)=>e.epoch-t.epoch):[],[l,i]),c=(0,r.useMemo)(()=>s.map(e=>e.reputation),[s]),u=(0,r.useMemo)(()=>s.map(e=>e.total_payoff),[s]),f=(0,r.useMemo)(()=>s.map(e=>e.avg_p_initiated),[s]);if(!i)return null;let p=d[i.agentType],g=i.interactionsInitiated+i.interactionsReceived,m=g>0?i.interactionsInitiated/g:.5;return(0,n.jsxs)("div",{className:"absolute top-4 left-4 w-72 bg-panel border border-border rounded-lg shadow-lg z-20 overflow-hidden",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:p.secondary}}),(0,n.jsx)("span",{className:"font-semibold text-sm",children:i.name})]}),(0,n.jsx)("button",{onClick:()=>a(null),className:"text-muted hover:text-text transition-colors text-lg leading-none",children:"x"})]}),(0,n.jsxs)("div",{className:"px-4 py-2 border-b border-border flex items-center gap-2",children:[(0,n.jsx)("span",{className:"text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full",style:{backgroundColor:p.primary,color:p.accent},children:h[i.agentType]}),(0,n.jsx)("span",{className:"text-xs text-muted",children:i.agentType}),i.isFrozen&&(0,n.jsx)("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-blue-900/50 text-blue-300",children:"FROZEN"}),i.isQuarantined&&(0,n.jsx)("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-red-900/50 text-red-300",children:"QUARANTINED"})]}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-px bg-border",children:[(0,n.jsx)(es,{label:"Reputation",value:er(i.reputation,3),sparkline:c,color:p.secondary}),(0,n.jsx)(es,{label:"Resources",value:er(i.resources,1)}),(0,n.jsx)(es,{label:"Total Payoff",value:er(i.totalPayoff,2),sparkline:u}),(0,n.jsx)(es,{label:"Avg P",value:el(i.avgP),sparkline:f,color:i.avgP>.6?"#6FCF97":i.avgP>.3?"#F2994A":"#EB5757"}),(0,n.jsx)(es,{label:"Initiated",value:String(i.interactionsInitiated)}),(0,n.jsx)(es,{label:"Received",value:String(i.interactionsReceived)})]}),g>0&&(0,n.jsxs)("div",{className:"px-4 py-2 border-t border-border",children:[(0,n.jsx)("div",{className:"text-[10px] text-muted uppercase tracking-wider mb-1",children:"Activity Balance"}),(0,n.jsxs)("div",{className:"flex h-2 rounded-full overflow-hidden bg-black/30",children:[(0,n.jsx)("div",{className:"transition-all duration-300",style:{width:"".concat(100*m,"%"),backgroundColor:p.secondary}}),(0,n.jsx)("div",{className:"transition-all duration-300",style:{width:"".concat((1-m)*100,"%"),backgroundColor:p.primary}})]}),(0,n.jsxs)("div",{className:"flex justify-between text-[9px] text-muted mt-0.5",children:[(0,n.jsxs)("span",{children:["Initiated ",el(m)]}),(0,n.jsxs)("span",{children:["Received ",el(1-m)]})]})]}),(0,n.jsxs)("div",{className:"px-4 py-1.5 border-t border-border text-[10px] text-muted text-center",children:["Epoch ",o," | Power: ",(100*i.scale).toFixed(0),"%"]})]})}function ei(e){let{data:t,color:a="#3ECFB4",width:r=48,height:l=16}=e;if(t.length<2)return null;let o=Math.min(...t),i=Math.max(...t)-o||1,s=t.map((e,a)=>{let n=a/(t.length-1)*r;return"".concat(n,",").concat(l-(e-o)/i*(l-2)-1)}).join(" ");return(0,n.jsx)("svg",{width:r,height:l,className:"inline-block ml-1 align-middle",children:(0,n.jsx)("polyline",{points:s,fill:"none",stroke:a,strokeWidth:"1.5",strokeLinejoin:"round",strokeLinecap:"round"})})}function es(e){let{label:t,value:a,color:r,sparkline:l}=e;return(0,n.jsxs)("div",{className:"bg-panel px-3 py-2",children:[(0,n.jsx)("div",{className:"text-[10px] text-muted uppercase tracking-wider",children:t}),(0,n.jsxs)("div",{className:"flex items-center justify-between mt-0.5",children:[(0,n.jsx)("span",{className:"text-sm font-mono",style:r?{color:r}:void 0,children:a}),l&&l.length>1&&(0,n.jsx)(ei,{data:l,color:r||"#3ECFB4"})]})]})}function ec(){var e,t,a;let{data:l,currentEpochSnap:o,overlays:i,currentEpoch:s}=N(),c=(0,r.useMemo)(()=>{if(!l)return{toxicity:[],avgP:[],gini:[],welfare:[]};let e=l.epoch_snapshots.slice(0,s+1);return{toxicity:e.map(e=>e.toxicity_rate),avgP:e.map(e=>e.avg_p),gini:e.map(e=>e.gini_coefficient),welfare:e.map(e=>e.total_welfare)}},[l,s]);return i.metricsHud&&o&&l?(0,n.jsxs)("div",{className:"absolute top-4 right-4 w-56 bg-panel border border-border rounded-lg shadow-lg z-20 text-xs",children:[(0,n.jsxs)("div",{className:"px-3 py-2 border-b border-border",children:[(0,n.jsxs)("span",{className:"text-muted",children:["Epoch ",o.epoch]}),(0,n.jsxs)("span",{className:"text-muted float-right",children:[o.n_agents," agents"]})]}),(0,n.jsxs)("div",{className:"p-3 space-y-2.5",children:[(0,n.jsx)(ed,{label:"Toxicity",value:el(o.toxicity_rate),color:o.toxicity_rate>.3?"#EB5757":o.toxicity_rate>.15?"#F2994A":"#6FCF97",sparkline:c.toxicity}),(0,n.jsx)(ed,{label:"Avg P",value:er(o.avg_p,3),color:Y(o.avg_p),sparkline:c.avgP}),(0,n.jsx)(ed,{label:"Quality Gap",value:er(o.quality_gap,3),color:o.quality_gap<0?"#EB5757":"#6FCF97"}),(0,n.jsx)(ed,{label:"Gini",value:er(o.gini_coefficient,3),color:o.gini_coefficient>.4?"#EB5757":"#F2994A",sparkline:c.gini}),(0,n.jsx)(ed,{label:"Total Welfare",value:er(o.total_welfare,1),sparkline:c.welfare}),(0,n.jsxs)("div",{className:"border-t border-border pt-2 mt-2",children:[(0,n.jsxs)("div",{className:"flex justify-between text-muted",children:[(0,n.jsx)("span",{children:"Interactions"}),(0,n.jsx)("span",{className:"font-mono",children:o.total_interactions})]}),(0,n.jsxs)("div",{className:"flex justify-between text-muted",children:[(0,n.jsx)("span",{children:"Accepted"}),(0,n.jsx)("span",{className:"font-mono text-accent",children:o.accepted_interactions})]}),(0,n.jsxs)("div",{className:"flex justify-between text-muted",children:[(0,n.jsx)("span",{children:"Rejected"}),(0,n.jsx)("span",{className:"font-mono text-alert",children:o.rejected_interactions})]})]}),(null!=(e=o.ecosystem_threat_level)?e:0)>0&&(0,n.jsx)("div",{className:"border-t border-border pt-2",children:(0,n.jsxs)("div",{className:"flex justify-between text-muted",children:[(0,n.jsx)("span",{children:"Threat Level"}),(0,n.jsx)("span",{className:"font-mono",style:{color:(null!=(t=o.ecosystem_threat_level)?t:0)>.5?"#EB5757":"#F2994A"},children:el(null!=(a=o.ecosystem_threat_level)?a:0)})]})}),o.n_frozen>0&&(0,n.jsxs)("div",{className:"flex justify-between text-muted",children:[(0,n.jsx)("span",{children:"Frozen"}),(0,n.jsx)("span",{className:"font-mono",style:{color:"#A8CFF5"},children:o.n_frozen})]}),o.n_quarantined>0&&(0,n.jsxs)("div",{className:"flex justify-between text-muted",children:[(0,n.jsx)("span",{children:"Quarantined"}),(0,n.jsx)("span",{className:"font-mono text-alert",children:o.n_quarantined})]})]})]}):null}function ed(e){let{label:t,value:a,color:r,sparkline:l}=e;return(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsx)("span",{className:"text-muted",children:t}),(0,n.jsx)("span",{className:"font-mono",style:r?{color:r}:void 0,children:a})]}),l&&l.length>1&&(0,n.jsx)(eh,{data:l,color:null!=r?r:"#3ECFB4"})]})}function eh(e){let{data:t,color:a}=e,r=Math.min(...t),l=Math.max(...t)-r||1,o=t.map((e,a)=>{let n=a/(t.length-1)*200;return"".concat(n,",").concat(16-(e-r)/l*14-1)});return(0,n.jsx)("svg",{width:"100%",height:16,viewBox:"0 0 ".concat(200," ").concat(16),preserveAspectRatio:"none",className:"mt-0.5",children:(0,n.jsx)("polyline",{points:o.join(" "),fill:"none",stroke:a,strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",opacity:"0.6"})})}function eu(){let e=(0,r.useRef)(null),{agents:t,overlays:a,viewport:l}=N(),{handlePan:o}=D();return((0,r.useEffect)(()=>{if(!a.minimap)return;let n=e.current;if(!n)return;let r=n.getContext("2d");if(!r)return;let o=devicePixelRatio;n.width=140*o,n.height=140*o,r.scale(o,o);let i=0,s=0,h=100,u=100;for(let e of t){let t=j(e.gridX,e.gridY);i=Math.min(i,t.x-40),s=Math.min(s,t.y-100),h=Math.max(h,t.x+40),u=Math.max(u,t.y+40)}let f=h-i||1,p=u-s||1,g=.85*Math.min(140/f,140/p),m=(140-f*g)/2,x=(140-p*g)/2;for(let e of(r.fillStyle=L(c.bg,.9),r.fillRect(0,0,140,140),t)){let t=j(e.gridX,e.gridY),a=(t.x-i)*g+m,n=(t.y-s)*g+x;r.fillStyle=d[e.agentType].secondary,r.beginPath(),r.arc(a,n,3,0,2*Math.PI),r.fill()}let y=(-l.x/l.zoom-i)*g+m,v=(-l.y/l.zoom-s)*g+x,b=l.width/l.zoom*g,S=l.height/l.zoom*g;r.strokeStyle=c.accent,r.lineWidth=1,r.strokeRect(y,v,b,S),r.strokeStyle=c.border,r.lineWidth=1,r.strokeRect(0,0,140,140)},[t,a.minimap,l]),a.minimap)?(0,n.jsx)("canvas",{ref:e,className:"absolute bottom-16 right-4 rounded border border-border z-20 cursor-pointer",style:{width:140,height:140}}):null}function ef(e){return()=>{e|=0;let t=Math.imul((e=e+0x6d2b79f5|0)^e>>>15,1|e);return(((t=t+Math.imul(t^t>>>7,61|t)^t)^t>>>14)>>>0)/0x100000000}}function ep(e){return Math.sqrt(-2*Math.log(e()||1e-10))*Math.cos(2*Math.PI*e())}let eg=["honest","opportunistic","deceptive","adversarial","rlm","crewai"],em={honest:{progressMean:.7,progressStd:.15,reworkProb:.05,rejectionProb:.02,engagementMean:.6,acceptanceThreshold:.2,disposition:.7,names:["Sentinel","Guardian","Beacon","Anchor","Steward","Warden","Shield","Paladin","Arbiter","Keeper"]},opportunistic:{progressMean:.4,progressStd:.25,reworkProb:.15,rejectionProb:.1,engagementMean:.2,acceptanceThreshold:.1,disposition:.3,names:["Broker","Trader","Hustler","Maverick","Gambit","Dealer","Shark","Schemer","Speculator","Rogue"]},deceptive:{progressMean:.2,progressStd:.3,reworkProb:.25,rejectionProb:.2,engagementMean:-.1,acceptanceThreshold:.05,disposition:-.2,names:["Mirage","Phantom","Shadow","Facade","Specter","Wraith","Veil","Decoy","Illusionist","Shade"]},adversarial:{progressMean:-.2,progressStd:.35,reworkProb:.35,rejectionProb:.3,engagementMean:-.4,acceptanceThreshold:0,disposition:-.5,names:["Viper","Striker","Havoc","Razr","Blitz","Chaos","Toxin","Bane","Ravager","Scourge"]},rlm:{progressMean:.5,progressStd:.2,reworkProb:.1,rejectionProb:.08,engagementMean:.3,acceptanceThreshold:.15,disposition:.5,names:["Nexus","Cortex","Axiom","Vertex","Synapse","Matrix","Vector","Tensor","Lambda","Neural"]},crewai:{progressMean:.6,progressStd:.18,reworkProb:.08,rejectionProb:.05,engagementMean:.5,acceptanceThreshold:.2,disposition:.6,names:["Forge","Assembly","Cluster","Hive","Colony","Swarm","Network","Grid","Nexus","Hub"]}};async function ex(e){let t;if("string"==typeof e){let a=await fetch(e);if(!a.ok)throw Error("Failed to load: ".concat(a.statusText));t=await a.text()}else t=await e.text();let a=JSON.parse(t);return function(e){if(!e.epoch_snapshots||!Array.isArray(e.epoch_snapshots))throw Error("Missing epoch_snapshots array");if(!Array.isArray(e.agent_snapshots)){var t;e.agent_snapshots=null!=(t=e.agent_snapshots)?t:[]}if(0===e.epoch_snapshots.length)throw Error("No epoch snapshots found")}(a),0===a.agent_snapshots.length&&a.epoch_snapshots.length>0&&(a.agent_snapshots=function(e){var t,a,n,r,l;let o=ef(null!=(t=e.seed)?t:42),i=e.n_agents||e.epoch_snapshots[0].n_agents||6,s=[],c=[];for(let e=0;e<i;e++){let t=e%eg.length,a=eg[t],n=em[a].names,r=n[e%n.length]+(e>=eg.length?"-".concat(Math.floor(e/eg.length)+1):""),l=em[a].disposition+(o()-.5)*.3;c.push({id:"agent-".concat(e),name:r,type:a,disposition:l})}let d=c.map(()=>({reputation:.5+(o()-.5)*.2,resources:10+5*o(),totalPayoff:0,initiated:0,received:0}));for(let t of e.epoch_snapshots)for(let e=0;e<c.length;e++){let h=c[e],u=d[e],f=o()-.5,p=(null!=(a=t.toxicity_rate)?a:0)*.5,g=.05*h.disposition+.03*f-.02*p;u.reputation=Math.max(0,Math.min(1,u.reputation+g));let m=(null!=(n=t.avg_payoff)?n:0)*(.8+.4*h.disposition)+2*f;u.totalPayoff+=m,u.resources=Math.max(0,u.resources+.1*m);let x=t.total_interactions/i,y=Math.max(0,Math.round(x*(.4+.3*o()))),v=Math.max(0,Math.round(x*(.3+.3*o())));u.initiated+=y,u.received+=v;let b=Math.max(0,Math.min(1,.5+.3*h.disposition+.1*f-(null!=(r=t.toxicity_rate)?r:0)*.15)),S=null!=(l=t.ecosystem_threat_level)?l:0,M="adversarial"===h.type&&S>.5&&u.reputation<.3&&o()>.4,w="deceptive"===h.type&&S>.4&&u.reputation<.35&&o()>.5;s.push({agent_id:h.id,epoch:t.epoch,name:h.name,agent_type:h.type,reputation:u.reputation,resources:u.resources,interactions_initiated:u.initiated,interactions_received:u.received,avg_p_initiated:b,avg_p_received:Math.max(0,Math.min(1,b+(o()-.5)*.1)),total_payoff:u.totalPayoff,is_frozen:M,is_quarantined:w})}return s}(a)),a.events&&Array.isArray(a.events)?a.events=a.events.filter(e=>!e.event_type||"interaction"===e.event_type):a.events=void 0,a}let ey={agents:[{type:"honest",count:3},{type:"opportunistic",count:1},{type:"deceptive",count:1},{type:"adversarial",count:0}],governance:{taxRate:.05,reputationDecay:.95,circuitBreakerEnabled:!1,circuitBreakerThreshold:.4},payoff:{s_plus:2,s_minus:1,h:2,theta:.5,rho_a:0,rho_b:0,w_rep:1},epochs:10,stepsPerEpoch:10,seed:42,sigmoidK:2},ev={taskProgress:.4,reworkPenalty:.2,verifierPenalty:.2,engagementSignal:.2};function eb(e,t){return 0===e?1:2*Math.pow(t,e)-1}class eS{computeVHat(e){let t=Math.max(-1,Math.min(1,e.taskProgressDelta)),a=eb(e.reworkCount,this.reworkDecay),n=eb(e.verifierRejections,this.rejectionDecay),r=Math.max(-1,Math.min(1,e.counterpartyEngagementDelta));return Math.max(-1,Math.min(1,this.weights.taskProgress*t+this.weights.reworkPenalty*a+this.weights.verifierPenalty*n+this.weights.engagementSignal*r))}computeP(e){return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return 1/(1+Math.exp(-t*Math.max(-10,Math.min(10,e))))}(e,this.sigmoidK)}computeLabels(e){let t=this.computeVHat(e),a=this.computeP(t);return{vHat:t,p:a}}constructor(e=ev,t=2,a=.3,n=.4){this.weights=function(e){let t=e.taskProgress+e.reworkPenalty+e.verifierPenalty+e.engagementSignal;return 0===t?{taskProgress:.25,reworkPenalty:.25,verifierPenalty:.25,engagementSignal:.25}:{taskProgress:e.taskProgress/t,reworkPenalty:e.reworkPenalty/t,verifierPenalty:e.verifierPenalty/t,engagementSignal:e.engagementSignal/t}}(e),this.sigmoidK=t,this.reworkDecay=a,this.rejectionDecay=n}}let eM={s_plus:2,s_minus:1,h:2,theta:.5,rho_a:0,rho_b:0,w_rep:1};class ew{expectedSurplus(e){return e*this.cfg.s_plus-(1-e)*this.cfg.s_minus}expectedHarm(e){return(1-e)*this.cfg.h}payoffInitiator(e,t,a,n){let r=this.expectedSurplus(e),l=this.expectedHarm(e);return this.cfg.theta*r-t-a-this.cfg.rho_a*l+this.cfg.w_rep*n}payoffCounterparty(e,t,a,n){let r=this.expectedSurplus(e),l=this.expectedHarm(e);return(1-this.cfg.theta)*r+t-a-this.cfg.rho_b*l+this.cfg.w_rep*n}constructor(e={}){this.cfg={...eM,...e}}}function eP(e){let{label:t,value:a,min:r,max:l,step:o,onChange:i,format:s}=e;return(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("span",{className:"text-xs text-muted w-28 shrink-0",children:t}),(0,n.jsx)("input",{type:"range",min:r,max:l,step:o,value:a,onChange:e=>i(parseFloat(e.target.value)),className:"flex-1 h-1 accent-accent"}),(0,n.jsx)("span",{className:"text-xs font-mono w-12 text-right",children:s?s(a):a})]})}function eT(e){let{title:t,collapsible:a,children:l}=e,[o,i]=(0,r.useState)(!a);return(0,n.jsxs)("div",{className:"border-t border-border pt-3 mt-3 first:border-0 first:pt-0 first:mt-0",children:[(0,n.jsxs)("button",{onClick:a?()=>i(!o):void 0,className:"text-xs font-bold uppercase tracking-wider mb-2 flex items-center gap-1 ".concat(a?"cursor-pointer hover:text-accent":"cursor-default"),children:[a&&(0,n.jsx)("span",{className:"text-muted",children:o?"":""}),t]}),o&&(0,n.jsx)("div",{className:"space-y-2",children:l})]})}function ek(e){let{onComplete:t}=e,[l,o]=(0,r.useState)({...ey}),{status:i,progress:s,error:c,run:d}=function(){let[e,t]=(0,r.useState)("idle"),[n,l]=(0,r.useState)(0),[o,i]=(0,r.useState)(null),[s,c]=(0,r.useState)(null),d=(0,r.useRef)(!1);return{status:e,progress:n,error:o,result:s,run:(0,r.useCallback)(e=>{return t("running"),l(0),i(null),c(null),d.current=!1,new Promise(r=>{try{let o=new Worker(a.tu(new URL(a.p+a.u(496),a.b)),{type:void 0});o.onmessage=e=>{let a=e.data;"progress"===a.type?l(a.epoch/a.totalEpochs):"complete"===a.type?(t("done"),l(1),c(a.data),o.terminate(),r(a.data)):"error"===a.type&&(t("error"),i(a.message),o.terminate(),r(null))},o.onerror=()=>{o.terminate(),n(e,r)},o.postMessage({type:"run",config:e})}catch(t){n(e,r)}});function n(e,a){try{let n=function(e,t){let a=ef(e.seed),n="sim-".concat(Date.now()),r=new eS(void 0,e.sigmoidK),l=new ew(e.payoff),o=function(e,t){let a=[],n=0;for(let r of e.agents){let e=em[r.type];if(e)for(let l=0;l<r.count;l++){let l=n%e.names.length,o=n>=e.names.length?"-".concat(Math.floor(n/e.names.length)+1):"";a.push({id:"agent-".concat(n),name:"".concat(e.names[l]).concat(o),type:r.type,reputation:.5+(t()-.5)*.2,resources:10+5*t(),totalPayoff:0,interactionsInitiated:0,interactionsReceived:0,sumPInitiated:0,sumPReceived:0,isFrozen:!1,isQuarantined:!1}),n++}}return a}(e,a),i=[],s=[],c=[];for(let f=0;f<e.epochs;f++){let p=[];for(let t=0;t<e.stepsPerEpoch;t++){let{result:i,event:s}=function(e,t,a,n,r,l,o,i){let s=e.map((e,t)=>({a:e,i:t})).filter(e=>{let{a:t}=e;return!t.isFrozen});if(s.length<2){var c,d,h,u;return{result:{p:.5,accepted:!1,initiatorPayoff:0,counterpartyPayoff:0},event:{event_type:"interaction",timestamp:new Date().toISOString(),epoch:l,step:o,interaction_id:"".concat(i,"-e").concat(l,"-s").concat(o),initiator:null!=(h=null==(c=e[0])?void 0:c.id)?h:"none",counterparty:null!=(u=null==(d=e[1])?void 0:d.id)?u:"none",interaction_type:"collaboration",accepted:!1,p:.5,v_hat:0}}}let f=s[Math.floor(r()*s.length)],p=f.a,g=function(e,t,a){let n;if(e.length<2)return t;do n=Math.floor(a()*e.length);while(n===t);return n}(e,f.i,r),m=e[g],x=function(e,t,a){let n=ep(a),r=Math.max(-1,Math.min(1,e.progressMean+e.progressStd*n+(t-.5)*.1)),l=a()<e.reworkProb?a()<e.reworkProb?2:1:0,o=a()<e.rejectionProb?a()<e.rejectionProb?2:1:0;return{taskProgressDelta:r,reworkCount:l,verifierRejections:o,counterpartyEngagementDelta:Math.max(-1,Math.min(1,e.engagementMean+.2*ep(a)+(t-.5)*.15))}}(em[p.type],p.reputation,r),{vHat:y,p:v}=t.computeLabels(x),b=em[m.type],S=p.reputation>=b.acceptanceThreshold&&!m.isFrozen,M=S?({taxRate:n,reputationDecay:1,circuitBreakerEnabled:!1,circuitBreakerThreshold:0}).taxRate:0,w=0,P=0;if(S){w=a.payoffInitiator(v,M,.01,p.reputation),P=a.payoffCounterparty(v,M,.01,m.reputation),p.totalPayoff+=w,m.totalPayoff+=P,p.resources=Math.max(0,p.resources+.1*w),m.resources=Math.max(0,m.resources+.1*P);let e=(v-.5)*.05;p.reputation=Math.max(0,Math.min(1,p.reputation+e)),m.reputation=Math.max(0,Math.min(1,m.reputation+.5*e))}p.interactionsInitiated++,m.interactionsReceived++,p.sumPInitiated+=v,m.sumPReceived+=v;let T={event_type:"interaction",timestamp:new Date().toISOString(),epoch:l,step:o,interaction_id:"".concat(i,"-e").concat(l,"-s").concat(o),initiator:p.id,counterparty:m.id,interaction_type:"collaboration",accepted:S,p:v,v_hat:y};return{result:{p:v,accepted:S,initiatorPayoff:w,counterpartyPayoff:P},event:T}}(o,r,l,e.governance.taxRate,a,f,t,n);p.push(i),c.push(s)}var d,h,u=e.governance.reputationDecay;for(let e of o)e.isFrozen||(e.reputation=.5+u*(e.reputation-.5));let g=function(e,t,a,n){let r=t.filter(e=>e.accepted),l=t.filter(e=>!e.accepted),o=r.length>0?r.reduce((e,t)=>e+(1-t.p),0)/r.length:0,i=r.length>0?r.reduce((e,t)=>e+t.p,0)/r.length:0,s=l.length>0?l.reduce((e,t)=>e+t.p,0)/l.length:0,c=r.length>0&&l.length>0?i-s:0,d=t.length>0?t.reduce((e,t)=>e+t.p,0)/t.length:.5,h=a.map(e=>e.totalPayoff),u=h.reduce((e,t)=>e+t,0),f=a.length>0?u/a.length:0,p=a.length>0?Math.sqrt(h.reduce((e,t)=>e+(t-f)**2,0)/a.length):0,g=a.map(e=>e.reputation),m=g.length>0?g.reduce((e,t)=>e+t,0)/g.length:.5,x=g.length>0?Math.sqrt(g.reduce((e,t)=>e+(t-m)**2,0)/g.length):0;return{simulation_id:n,epoch:e,timestamp:new Date().toISOString(),total_interactions:t.length,accepted_interactions:r.length,rejected_interactions:l.length,toxicity_rate:o,quality_gap:c,avg_p:d,total_welfare:u,avg_payoff:f,payoff_std:p,gini_coefficient:function(e){let t=e.length;if(0===t)return 0;let a=[...e].sort((e,t)=>e-t),n=0;for(let e=0;e<t;e++)n+=(2*(e+1)-t-1)*a[e];let r=a.reduce((e,t)=>e+t,0)/t;return 0===r?0:n/(t*t*r)}(h.map(e=>Math.max(0,e))),total_posts:r.length,total_votes:Math.floor(.3*t.length),total_tasks_completed:r.length,n_agents:a.length,n_frozen:a.filter(e=>e.isFrozen).length,n_quarantined:a.filter(e=>e.isQuarantined).length,avg_reputation:m,reputation_std:x}}(f,p,o,n);for(let t of(i.push(g),d=e.governance,h=g.toxicity_rate,d.circuitBreakerEnabled&&h>d.circuitBreakerThreshold&&function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.25;for(let a of e)a.reputation<t&&(a.isFrozen=!0)}(o),o))s.push(function(e,t){let a=e.interactionsInitiated>0?e.sumPInitiated/e.interactionsInitiated:.5,n=e.interactionsReceived>0?e.sumPReceived/e.interactionsReceived:.5;return{agent_id:e.id,epoch:t,name:e.name,agent_type:e.type,reputation:e.reputation,resources:e.resources,interactions_initiated:e.interactionsInitiated,interactions_received:e.interactionsReceived,avg_p_initiated:a,avg_p_received:n,total_payoff:e.totalPayoff,is_frozen:e.isFrozen,is_quarantined:e.isQuarantined}}(t,f));null==t||t(f+1,e.epochs)}return{simulation_id:n,started_at:new Date().toISOString(),ended_at:new Date().toISOString(),n_epochs:e.epochs,steps_per_epoch:e.stepsPerEpoch,n_agents:o.length,seed:e.seed,epoch_snapshots:i,agent_snapshots:s,events:c}}(e,(e,t)=>{l(e/t)});t("done"),l(1),c(n),a(n)}catch(e){t("error"),i(e instanceof Error?e.message:String(e)),a(null)}}},[]),cancel:(0,r.useCallback)(()=>{d.current=!0,t("idle")},[])}}(),h=(0,r.useCallback)((e,t)=>{o(a=>{let n=[...a.agents];return n[e]={...n[e],count:t},{...a,agents:n}})},[]),u=(0,r.useCallback)((e,t)=>{o(a=>({...a,governance:{...a.governance,[e]:t}}))},[]),f=(0,r.useCallback)((e,t)=>{o(a=>({...a,payoff:{...a.payoff,[e]:t}}))},[]),p=(0,r.useCallback)(async()=>{if(2>l.agents.reduce((e,t)=>e+t.count,0))return void alert("Need at least 2 agents to run a simulation.");let e=await d(l);e&&t(e)},[l,d,t]),g="running"===i;return(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsxs)(eT,{title:"Agents",children:[l.agents.map((e,t)=>(0,n.jsx)(eP,{label:e.type.charAt(0).toUpperCase()+e.type.slice(1),value:e.count,min:0,max:10,step:1,onChange:e=>h(t,e)},e.type)),(0,n.jsxs)("p",{className:"text-xs text-muted",children:["Total: ",l.agents.reduce((e,t)=>e+t.count,0)," agents"]})]}),(0,n.jsxs)(eT,{title:"Governance",children:[(0,n.jsx)(eP,{label:"Tax rate",value:l.governance.taxRate,min:0,max:.5,step:.01,onChange:e=>u("taxRate",e),format:e=>e.toFixed(2)}),(0,n.jsx)(eP,{label:"Rep. decay",value:l.governance.reputationDecay,min:.8,max:1,step:.01,onChange:e=>u("reputationDecay",e),format:e=>e.toFixed(2)}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("span",{className:"text-xs text-muted w-28 shrink-0",children:"Circuit breaker"}),(0,n.jsx)("button",{onClick:()=>u("circuitBreakerEnabled",!l.governance.circuitBreakerEnabled),className:"px-2 py-0.5 rounded text-xs ".concat(l.governance.circuitBreakerEnabled?"bg-accent text-bg":"bg-btn"),children:l.governance.circuitBreakerEnabled?"ON":"OFF"}),l.governance.circuitBreakerEnabled&&(0,n.jsxs)("span",{className:"text-xs text-muted",children:["@ ",l.governance.circuitBreakerThreshold]})]})]}),(0,n.jsxs)(eT,{title:"Payoff Parameters",collapsible:!0,children:[(0,n.jsx)(eP,{label:"s_plus",value:l.payoff.s_plus,min:0,max:5,step:.1,onChange:e=>f("s_plus",e),format:e=>e.toFixed(1)}),(0,n.jsx)(eP,{label:"s_minus",value:l.payoff.s_minus,min:0,max:5,step:.1,onChange:e=>f("s_minus",e),format:e=>e.toFixed(1)}),(0,n.jsx)(eP,{label:"h (harm)",value:l.payoff.h,min:0,max:5,step:.1,onChange:e=>f("h",e),format:e=>e.toFixed(1)}),(0,n.jsx)(eP,{label:"theta",value:l.payoff.theta,min:0,max:1,step:.05,onChange:e=>f("theta",e),format:e=>e.toFixed(2)}),(0,n.jsx)(eP,{label:"rho_a",value:l.payoff.rho_a,min:0,max:1,step:.05,onChange:e=>f("rho_a",e),format:e=>e.toFixed(2)}),(0,n.jsx)(eP,{label:"rho_b",value:l.payoff.rho_b,min:0,max:1,step:.05,onChange:e=>f("rho_b",e),format:e=>e.toFixed(2)})]}),(0,n.jsxs)(eT,{title:"Simulation",collapsible:!0,children:[(0,n.jsx)(eP,{label:"Epochs",value:l.epochs,min:5,max:100,step:5,onChange:e=>o(t=>({...t,epochs:e}))}),(0,n.jsx)(eP,{label:"Steps/epoch",value:l.stepsPerEpoch,min:5,max:50,step:5,onChange:e=>o(t=>({...t,stepsPerEpoch:e}))}),(0,n.jsx)(eP,{label:"Seed",value:l.seed,min:1,max:9999,step:1,onChange:e=>o(t=>({...t,seed:e}))})]}),(0,n.jsxs)("div",{className:"pt-3 mt-3 border-t border-border",children:[(0,n.jsx)("button",{onClick:p,disabled:g,className:"w-full py-2 rounded font-bold text-sm bg-accent text-bg hover:opacity-90 disabled:opacity-50 transition-opacity",children:g?"Running...":"Run Simulation"}),g&&(0,n.jsx)("div",{className:"mt-2 h-1.5 bg-btn rounded overflow-hidden",children:(0,n.jsx)("div",{className:"h-full bg-accent transition-all duration-200",style:{width:"".concat(Math.round(100*s),"%")}})}),c&&(0,n.jsx)("p",{className:"text-xs text-red-400 mt-2",children:c})]})]})}let e_="/game-app",eC=[{name:"Adversarial Red Team (75 epochs)",path:"".concat(e_,"/sample-data/adversarial-redteam-75.json")},{name:"RLM Governance Lag (50 epochs)",path:"".concat(e_,"/sample-data/rlm-governance-lag-50.json")},{name:"Collusion Detection (60 epochs)",path:"".concat(e_,"/sample-data/collusion-detection-60.json")},{name:"24-Agent Mixed Demo",path:"".concat(e_,"/sample-data/demo-history-24.json")},{name:"6-Agent Mixed Demo",path:"".concat(e_,"/sample-data/demo-history.json")}];function ej(){let{data:e,loadData:t}=N(),a=(0,r.useRef)(null),[l,o]=(0,r.useState)("load"),i=(0,r.useCallback)(async e=>{try{let a=await ex(e);t(a)}catch(e){alert("Error loading file: ".concat(e instanceof Error?e.message:e))}},[t]),s=(0,r.useCallback)(async e=>{try{let a=await ex(e);t(a)}catch(e){alert("Error loading sample: ".concat(e instanceof Error?e.message:e))}},[t]);return e?null:(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center z-30 bg-bg",children:(0,n.jsxs)("div",{className:"bg-panel border border-border rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto",children:[(0,n.jsx)("h1",{className:"text-xl font-bold mb-1",children:"SWARM Isometric Viewer"}),(0,n.jsx)("p",{className:"text-sm text-muted mb-4",children:"Visualize multi-agent simulation data as an interactive isometric city"}),(0,n.jsxs)("div",{className:"flex gap-1 mb-4 bg-btn rounded-lg p-0.5",children:[(0,n.jsx)("button",{onClick:()=>o("load"),className:"flex-1 py-1.5 rounded text-xs font-bold transition-colors ".concat("load"===l?"bg-panel text-text":"text-muted hover:text-text"),children:"Load File"}),(0,n.jsx)("button",{onClick:()=>o("simulate"),className:"flex-1 py-1.5 rounded text-xs font-bold transition-colors ".concat("simulate"===l?"bg-panel text-text":"text-muted hover:text-text"),children:"Run Simulation"})]}),"load"===l?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"border-2 border-dashed border-border rounded-lg p-6 text-center cursor-pointer hover:border-accent transition-colors mb-4",onClick:()=>{var e;return null==(e=a.current)?void 0:e.click()},onDragOver:e=>{e.preventDefault(),e.currentTarget.classList.add("border-accent")},onDragLeave:e=>{e.currentTarget.classList.remove("border-accent")},onDrop:e=>{e.preventDefault(),e.currentTarget.classList.remove("border-accent");let t=e.dataTransfer.files[0];t&&i(t)},children:[(0,n.jsx)("div",{className:"text-3xl mb-2 text-accent",children:"+"}),(0,n.jsxs)("p",{className:"text-sm text-muted",children:["Drop a ",(0,n.jsx)("span",{className:"text-text font-mono",children:"history.json"})," here"]}),(0,n.jsx)("p",{className:"text-xs text-muted mt-1",children:"or click to browse"})]}),(0,n.jsx)("input",{ref:a,type:"file",accept:".json",className:"hidden",onChange:e=>{var t;let a=null==(t=e.target.files)?void 0:t[0];a&&i(a)}}),(0,n.jsxs)("div",{className:"border-t border-border pt-4",children:[(0,n.jsx)("p",{className:"text-xs text-muted mb-2",children:"Or load sample data:"}),(0,n.jsx)("div",{className:"space-y-2",children:eC.map(e=>(0,n.jsx)("button",{onClick:()=>s(e.path),className:"w-full text-left px-3 py-2 rounded bg-btn hover:bg-btn-hover transition-colors text-sm",children:e.name},e.path))})]})]}):(0,n.jsx)(ek,{onComplete:t})]})})}let eF=[{key:"interactions",label:"Arcs"},{key:"metricsHud",label:"HUD"},{key:"particles",label:"FX"},{key:"minimap",label:"Map"},{key:"collusionLines",label:"Collusion"},{key:"threatZones",label:"Threats"},{key:"digitalRain",label:"Rain"},{key:"tierraStrip",label:"Memory"},{key:"networkWeb",label:"Network"}];function eI(){let{overlays:e,toggleOverlay:t,data:a}=N();return a?(0,n.jsx)("div",{className:"absolute bottom-24 left-4 flex flex-wrap gap-1 z-20 max-w-xs",children:eF.map(a=>{let{key:r,label:l}=a;return(0,n.jsx)("button",{onClick:()=>t(r),className:"px-2.5 py-1 text-[10px] rounded-full border transition-colors ".concat(e[r]?"bg-accent/20 border-accent/50 text-accent":"bg-btn border-border text-muted hover:text-text"),children:l},r)})}):null}function eE(){let[e,t]=(0,r.useState)("enter"),a=(0,r.useCallback)(()=>{"done"!==e&&t("exit")},[e]);return((0,r.useEffect)(()=>{let e=setTimeout(()=>{t(e=>"enter"===e?"exit":e)},2500);return()=>clearTimeout(e)},[]),(0,r.useEffect)(()=>{if("exit"===e){let e=setTimeout(()=>t("done"),700);return()=>clearTimeout(e)}},[e]),"done"===e)?null:(0,n.jsx)("div",{className:"absolute inset-0 z-50 flex items-center justify-center bg-bg cursor-pointer ".concat("exit"===e?"animate-[splash-exit_0.7s_ease-in_forwards]":""),onClick:a,children:(0,n.jsx)("img",{src:"".concat("/game-app","/splash.png"),alt:"SWARM",className:"w-64 h-64 object-contain ".concat("enter"===e?"animate-[splash-enter_0.8s_ease-out_forwards,splash-glow_1.7s_ease-in-out_0.8s_infinite]":"")})})}function eR(){return(0,n.jsx)(A,{children:(0,n.jsxs)("div",{className:"relative w-screen h-screen overflow-hidden bg-bg",children:[(0,n.jsx)("div",{className:"absolute inset-0",children:(0,n.jsx)(et,{})}),(0,n.jsx)(ej,{}),(0,n.jsx)(eo,{}),(0,n.jsx)(ec,{}),(0,n.jsx)(eu,{}),(0,n.jsx)(eI,{}),(0,n.jsx)(en,{}),(0,n.jsx)(eE,{})]})})}function eA(){return(0,n.jsx)(eR,{})}}},e=>{e.O(0,[441,255,358],()=>e(e.s=3777)),_N_E=e.O()}]);