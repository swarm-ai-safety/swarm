(()=>{"use strict";function e(e){return Math.sqrt(-2*Math.log(e()||1e-10))*Math.cos(2*Math.PI*e())}let t={taskProgress:.4,reworkPenalty:.2,verifierPenalty:.2,engagementSignal:.2};function r(e,t){return 0===e?1:2*Math.pow(t,e)-1}class n{computeVHat(e){let t=Math.max(-1,Math.min(1,e.taskProgressDelta)),n=r(e.reworkCount,this.reworkDecay),a=r(e.verifierRejections,this.rejectionDecay),i=Math.max(-1,Math.min(1,e.counterpartyEngagementDelta));return Math.max(-1,Math.min(1,this.weights.taskProgress*t+this.weights.reworkPenalty*n+this.weights.verifierPenalty*a+this.weights.engagementSignal*i))}computeP(e){return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return 1/(1+Math.exp(-t*Math.max(-10,Math.min(10,e))))}(e,this.sigmoidK)}computeLabels(e){let t=this.computeVHat(e),r=this.computeP(t);return{vHat:t,p:r}}constructor(e=t,r=2,n=.3,a=.4){this.weights=function(e){let t=e.taskProgress+e.reworkPenalty+e.verifierPenalty+e.engagementSignal;return 0===t?{taskProgress:.25,reworkPenalty:.25,verifierPenalty:.25,engagementSignal:.25}:{taskProgress:e.taskProgress/t,reworkPenalty:e.reworkPenalty/t,verifierPenalty:e.verifierPenalty/t,engagementSignal:e.engagementSignal/t}}(e),this.sigmoidK=r,this.reworkDecay=n,this.rejectionDecay=a}}let a={s_plus:2,s_minus:1,h:2,theta:.5,rho_a:0,rho_b:0,w_rep:1};class i{expectedSurplus(e){return e*this.cfg.s_plus-(1-e)*this.cfg.s_minus}expectedHarm(e){return(1-e)*this.cfg.h}payoffInitiator(e,t,r,n){let a=this.expectedSurplus(e),i=this.expectedHarm(e);return this.cfg.theta*a-t-r-this.cfg.rho_a*i+this.cfg.w_rep*n}payoffCounterparty(e,t,r,n){let a=this.expectedSurplus(e),i=this.expectedHarm(e);return(1-this.cfg.theta)*a+t-r-this.cfg.rho_b*i+this.cfg.w_rep*n}constructor(e={}){this.cfg={...a,...e}}}let o={honest:{progressMean:.7,progressStd:.15,reworkProb:.05,rejectionProb:.02,engagementMean:.6,acceptanceThreshold:.2,disposition:.7,names:["Sentinel","Guardian","Beacon","Anchor","Steward","Warden","Shield","Paladin","Arbiter","Keeper"]},opportunistic:{progressMean:.4,progressStd:.25,reworkProb:.15,rejectionProb:.1,engagementMean:.2,acceptanceThreshold:.1,disposition:.3,names:["Broker","Trader","Hustler","Maverick","Gambit","Dealer","Shark","Schemer","Speculator","Rogue"]},deceptive:{progressMean:.2,progressStd:.3,reworkProb:.25,rejectionProb:.2,engagementMean:-.1,acceptanceThreshold:.05,disposition:-.2,names:["Mirage","Phantom","Shadow","Facade","Specter","Wraith","Veil","Decoy","Illusionist","Shade"]},adversarial:{progressMean:-.2,progressStd:.35,reworkProb:.35,rejectionProb:.3,engagementMean:-.4,acceptanceThreshold:0,disposition:-.5,names:["Viper","Striker","Havoc","Razr","Blitz","Chaos","Toxin","Bane","Ravager","Scourge"]},rlm:{progressMean:.5,progressStd:.2,reworkProb:.1,rejectionProb:.08,engagementMean:.3,acceptanceThreshold:.15,disposition:.5,names:["Nexus","Cortex","Axiom","Vertex","Synapse","Matrix","Vector","Tensor","Lambda","Neural"]},crewai:{progressMean:.6,progressStd:.18,reworkProb:.08,rejectionProb:.05,engagementMean:.5,acceptanceThreshold:.2,disposition:.6,names:["Forge","Assembly","Cluster","Hive","Colony","Swarm","Network","Grid","Nexus","Hub"]}};self.onmessage=t=>{let r=t.data;if("run"===r.type)try{let t=function(t,r){var a;let s=(a=t.seed,()=>{a|=0;let e=Math.imul((a=a+0x6d2b79f5|0)^a>>>15,1|a);return(((e=e+Math.imul(e^e>>>7,61|e)^e)^e>>>14)>>>0)/0x100000000}),c="sim-".concat(Date.now()),l=new n(void 0,t.sigmoidK),h=new i(t.payoff),p=function(e,t){let r=[],n=0;for(let a of e.agents){let e=o[a.type];if(e)for(let i=0;i<a.count;i++){let i=n%e.names.length,o=n>=e.names.length?"-".concat(Math.floor(n/e.names.length)+1):"";r.push({id:"agent-".concat(n),name:"".concat(e.names[i]).concat(o),type:a.type,reputation:.5+(t()-.5)*.2,resources:10+5*t(),totalPayoff:0,interactionsInitiated:0,interactionsReceived:0,sumPInitiated:0,sumPReceived:0,isFrozen:!1,isQuarantined:!1}),n++}}return r}(t,s),g=[],u=[],d=[];for(let n=0;n<t.epochs;n++){let a=[];for(let r=0;r<t.stepsPerEpoch;r++){let{result:i,event:g}=function(t,r,n,a,i,s,c,l){let h=t.map((e,t)=>({a:e,i:t})).filter(e=>{let{a:t}=e;return!t.isFrozen});if(h.length<2){var p,g,u,d;return{result:{p:.5,accepted:!1,initiatorPayoff:0,counterpartyPayoff:0},event:{event_type:"interaction",timestamp:new Date().toISOString(),epoch:s,step:c,interaction_id:"".concat(l,"-e").concat(s,"-s").concat(c),initiator:null!=(u=null==(p=t[0])?void 0:p.id)?u:"none",counterparty:null!=(d=null==(g=t[1])?void 0:g.id)?d:"none",interaction_type:"collaboration",accepted:!1,p:.5,v_hat:0}}}let f=h[Math.floor(i()*h.length)],m=f.a,y=function(e,t,r){let n;if(e.length<2)return t;do n=Math.floor(r()*e.length);while(n===t);return n}(t,f.i,i),_=t[y],P=function(t,r,n){let a=e(n),i=Math.max(-1,Math.min(1,t.progressMean+t.progressStd*a+(r-.5)*.1)),o=n()<t.reworkProb?n()<t.reworkProb?2:1:0,s=n()<t.rejectionProb?n()<t.rejectionProb?2:1:0;return{taskProgressDelta:i,reworkCount:o,verifierRejections:s,counterpartyEngagementDelta:Math.max(-1,Math.min(1,t.engagementMean+.2*e(n)+(r-.5)*.15))}}(o[m.type],m.reputation,i),{vHat:M,p:v}=r.computeLabels(P),w=o[_.type],S=m.reputation>=w.acceptanceThreshold&&!_.isFrozen,k=S?({taxRate:a,reputationDecay:1,circuitBreakerEnabled:!1,circuitBreakerThreshold:0}).taxRate:0,x=0,b=0;if(S){x=n.payoffInitiator(v,k,.01,m.reputation),b=n.payoffCounterparty(v,k,.01,_.reputation),m.totalPayoff+=x,_.totalPayoff+=b,m.resources=Math.max(0,m.resources+.1*x),_.resources=Math.max(0,_.resources+.1*b);let e=(v-.5)*.05;m.reputation=Math.max(0,Math.min(1,m.reputation+e)),_.reputation=Math.max(0,Math.min(1,_.reputation+.5*e))}m.interactionsInitiated++,_.interactionsReceived++,m.sumPInitiated+=v,_.sumPReceived+=v;let D={event_type:"interaction",timestamp:new Date().toISOString(),epoch:s,step:c,interaction_id:"".concat(l,"-e").concat(s,"-s").concat(c),initiator:m.id,counterparty:_.id,interaction_type:"collaboration",accepted:S,p:v,v_hat:M};return{result:{p:v,accepted:S,initiatorPayoff:x,counterpartyPayoff:b},event:D}}(p,l,h,t.governance.taxRate,s,n,r,c);a.push(i),d.push(g)}var f,m,y=t.governance.reputationDecay;for(let e of p)e.isFrozen||(e.reputation=.5+y*(e.reputation-.5));let i=function(e,t,r,n){let a=t.filter(e=>e.accepted),i=t.filter(e=>!e.accepted),o=a.length>0?a.reduce((e,t)=>e+(1-t.p),0)/a.length:0,s=a.length>0?a.reduce((e,t)=>e+t.p,0)/a.length:0,c=i.length>0?i.reduce((e,t)=>e+t.p,0)/i.length:0,l=a.length>0&&i.length>0?s-c:0,h=t.length>0?t.reduce((e,t)=>e+t.p,0)/t.length:.5,p=r.map(e=>e.totalPayoff),g=p.reduce((e,t)=>e+t,0),u=r.length>0?g/r.length:0,d=r.length>0?Math.sqrt(p.reduce((e,t)=>e+(t-u)**2,0)/r.length):0,f=r.map(e=>e.reputation),m=f.length>0?f.reduce((e,t)=>e+t,0)/f.length:.5,y=f.length>0?Math.sqrt(f.reduce((e,t)=>e+(t-m)**2,0)/f.length):0;return{simulation_id:n,epoch:e,timestamp:new Date().toISOString(),total_interactions:t.length,accepted_interactions:a.length,rejected_interactions:i.length,toxicity_rate:o,quality_gap:l,avg_p:h,total_welfare:g,avg_payoff:u,payoff_std:d,gini_coefficient:function(e){let t=e.length;if(0===t)return 0;let r=[...e].sort((e,t)=>e-t),n=0;for(let e=0;e<t;e++)n+=(2*(e+1)-t-1)*r[e];let a=r.reduce((e,t)=>e+t,0)/t;return 0===a?0:n/(t*t*a)}(p.map(e=>Math.max(0,e))),total_posts:a.length,total_votes:Math.floor(.3*t.length),total_tasks_completed:a.length,n_agents:r.length,n_frozen:r.filter(e=>e.isFrozen).length,n_quarantined:r.filter(e=>e.isQuarantined).length,avg_reputation:m,reputation_std:y}}(n,a,p,c);for(let e of(g.push(i),f=t.governance,m=i.toxicity_rate,f.circuitBreakerEnabled&&m>f.circuitBreakerThreshold&&function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.25;for(let r of e)r.reputation<t&&(r.isFrozen=!0)}(p),p))u.push(function(e,t){let r=e.interactionsInitiated>0?e.sumPInitiated/e.interactionsInitiated:.5,n=e.interactionsReceived>0?e.sumPReceived/e.interactionsReceived:.5;return{agent_id:e.id,epoch:t,name:e.name,agent_type:e.type,reputation:e.reputation,resources:e.resources,interactions_initiated:e.interactionsInitiated,interactions_received:e.interactionsReceived,avg_p_initiated:r,avg_p_received:n,total_payoff:e.totalPayoff,is_frozen:e.isFrozen,is_quarantined:e.isQuarantined}}(e,n));null==r||r(n+1,t.epochs)}return{simulation_id:c,started_at:new Date().toISOString(),ended_at:new Date().toISOString(),n_epochs:t.epochs,steps_per_epoch:t.stepsPerEpoch,n_agents:p.length,seed:t.seed,epoch_snapshots:g,agent_snapshots:u,events:d}}(r.config,(e,t)=>{self.postMessage({type:"progress",epoch:e,totalEpochs:t})});self.postMessage({type:"complete",data:t})}catch(t){let e={type:"error",message:t instanceof Error?t.message:String(t)};self.postMessage(e)}}})(),_N_E={};